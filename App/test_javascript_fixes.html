<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoSDK JavaScript Fixes Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #1a1a1a; 
            color: white; 
        }
        .test-section {
            background: #333;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #444;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
        }
        #video-grid {
            background: #222;
            min-height: 200px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-style: italic;
            color: #888;
        }
    </style>
</head>
<body>
    <h1>üîß VideoSDK JavaScript Fixes Test</h1>
    <p>This test validates the JavaScript module system fixes for VideoSDK integration.</p>

    <div class="test-section">
        <h2>1. Module System Compatibility Test</h2>
        <div id="module-test-results">Testing...</div>
        <button onclick="testModuleSystem()">Re-test Module System</button>
    </div>

    <div class="test-section">
        <h2>2. VideoSDK Configuration Test</h2>
        <div id="config-test-results">Testing...</div>
        <button onclick="testConfiguration()">Re-test Configuration</button>
    </div>

    <div class="test-section">
        <h2>3. VideoSDK Library Loading Test</h2>
        <div id="library-test-results">Ready to test</div>
        <button onclick="testVideoSDKLoading()">Test VideoSDK Loading</button>
        <div id="video-grid">Video container (for testing)</div>
    </div>

    <div class="test-section">
        <h2>4. Error Handling Test</h2>
        <div id="error-test-results">Ready to test</div>
        <button onclick="testErrorHandling()">Test Error Handling</button>
    </div>

    <!-- Early module system compatibility - identical to voice-section.php -->
    <script>
    (function() {
        'use strict';
        
        // Comprehensive module system polyfill for VideoSDK compatibility
        console.log('üîß Setting up module system compatibility...');
        
        // CommonJS compatibility
        if (typeof window.exports === 'undefined') {
            window.exports = {};
            console.log('‚úì window.exports polyfill added');
        }
        
        if (typeof window.module === 'undefined') {
            window.module = { 
                exports: window.exports,
                id: 'browser',
                filename: window.location.href,
                loaded: false,
                children: [],
                paths: []
            };
            console.log('‚úì window.module polyfill added');
        }
        
        if (typeof window.global === 'undefined') {
            window.global = window;
            console.log('‚úì window.global polyfill added');
        }
        
        // AMD compatibility (if needed)
        if (typeof window.define === 'undefined') {
            window.define = function(name, deps, callback) {
                if (typeof name === 'function') {
                    callback = name;
                    deps = [];
                    name = undefined;
                } else if (typeof deps === 'function') {
                    callback = deps;
                    deps = [];
                }
                if (callback && typeof callback === 'function') {
                    const result = callback();
                    if (result !== undefined) {
                        window.exports = result;
                    }
                }
            };
            window.define.amd = true;
            console.log('‚úì AMD define polyfill added');
        }
        
        // CommonJS require polyfill
        if (typeof window.require === 'undefined') {
            window.require = function(module) {
                console.warn('CommonJS require() called for:', module);
                
                // Basic module resolution for known patterns
                switch (module) {
                    case 'events':
                        return { EventEmitter: class EventEmitter {} };
                    case 'util':
                        return { inherits: function() {} };
                    case 'stream':
                        return {};
                    default:
                        return window.exports || {};
                }
            };
            console.log('‚úì CommonJS require polyfill added');
        }
        
        // Enhanced error handler for module system errors
        const originalErrorHandler = window.onerror;
        window.onerror = function(message, source, lineno, colno, error) {
            if (message && typeof message === 'string') {
                if (message.includes('exports is not defined') || 
                    message.includes('module is not defined') ||
                    message.includes('require is not defined')) {
                    console.log('üõ†Ô∏è Module system error caught and handled:', message);
                    return true; // Prevent default error handling
                }
            }
            
            if (originalErrorHandler) {
                return originalErrorHandler.apply(this, arguments);
            }
            return false;
        };
        
        // Enhanced unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && 
                (event.reason.message.includes('exports is not defined') ||
                 event.reason.message.includes('module is not defined'))) {
                console.log('üõ†Ô∏è Module system promise rejection handled:', event.reason.message);
                event.preventDefault();
            }
        });
        
        console.log('‚úÖ Module system compatibility setup complete');
    })();
    </script>

    <script>
        // Test configuration (simulating the PHP-generated config)
        const videoSdkConfig = {
            apiKey: 'test-api-key-12345678',
            token: 'test-token-abcdefghijklmnopqrstuvwxyz',
            isProduction: false
        };

        function testModuleSystem() {
            const results = document.getElementById('module-test-results');
            let html = '<h3>Module System Test Results:</h3>';
            
            try {
                // Test 1: Check if polyfills exist
                html += '<p class="' + (typeof window.exports !== 'undefined' ? 'success' : 'error') + '">window.exports: ' + (typeof window.exports !== 'undefined' ? '‚úì Available' : '‚ùå Missing') + '</p>';
                html += '<p class="' + (typeof window.module !== 'undefined' ? 'success' : 'error') + '">window.module: ' + (typeof window.module !== 'undefined' ? '‚úì Available' : '‚ùå Missing') + '</p>';
                html += '<p class="' + (typeof window.global !== 'undefined' ? 'success' : 'error') + '">window.global: ' + (typeof window.global !== 'undefined' ? '‚úì Available' : '‚ùå Missing') + '</p>';
                html += '<p class="' + (typeof window.require !== 'undefined' ? 'success' : 'error') + '">window.require: ' + (typeof window.require !== 'undefined' ? '‚úì Available' : '‚ùå Missing') + '</p>';
                
                // Test 2: Try to trigger module system errors
                html += '<h4>Error Handling Test:</h4>';
                try {
                    eval('exports.test = "hello";');
                    html += '<p class="success">‚úì exports assignment works</p>';
                } catch (e) {
                    html += '<p class="error">‚ùå exports assignment failed: ' + e.message + '</p>';
                }
                
                try {
                    eval('module.exports = {test: "hello"};');
                    html += '<p class="success">‚úì module.exports assignment works</p>';
                } catch (e) {
                    html += '<p class="error">‚ùå module.exports assignment failed: ' + e.message + '</p>';
                }
                
                html += '<p class="success">‚úÖ Module system compatibility test completed</p>';
                
            } catch (error) {
                html += '<p class="error">‚ùå Module system test failed: ' + error.message + '</p>';
            }
            
            results.innerHTML = html;
        }

        function testConfiguration() {
            const results = document.getElementById('config-test-results');
            let html = '<h3>Configuration Test Results:</h3>';
            
            try {
                // Test configuration structure
                html += '<p class="' + (videoSdkConfig ? 'success' : 'error') + '">Config object: ' + (videoSdkConfig ? '‚úì Available' : '‚ùå Missing') + '</p>';
                
                if (videoSdkConfig) {
                    html += '<p class="' + (videoSdkConfig.apiKey ? 'success' : 'error') + '">API Key: ' + (videoSdkConfig.apiKey ? '‚úì Present (' + videoSdkConfig.apiKey.substring(0, 8) + '...)' : '‚ùå Missing') + '</p>';
                    html += '<p class="' + (videoSdkConfig.token ? 'success' : 'error') + '">Token: ' + (videoSdkConfig.token ? '‚úì Present (' + videoSdkConfig.token.substring(0, 20) + '...)' : '‚ùå Missing') + '</p>';
                    html += '<p class="info">Production Mode: ' + (videoSdkConfig.isProduction ? 'Yes' : 'No') + '</p>';
                    
                    // Test JSON serialization
                    try {
                        const serialized = JSON.stringify(videoSdkConfig);
                        html += '<p class="success">‚úì Configuration can be serialized</p>';
                        html += '<pre>' + serialized + '</pre>';
                    } catch (e) {
                        html += '<p class="error">‚ùå Configuration serialization failed: ' + e.message + '</p>';
                    }
                }
                
                html += '<p class="success">‚úÖ Configuration test completed</p>';
                
            } catch (error) {
                html += '<p class="error">‚ùå Configuration test failed: ' + error.message + '</p>';
            }
            
            results.innerHTML = html;
        }

        function testVideoSDKLoading() {
            const results = document.getElementById('library-test-results');
            results.innerHTML = '<p class="info">üîÑ Loading VideoSDK library...</p>';
            
            // Check if already loaded
            if (typeof VideoSDKMeeting !== 'undefined') {
                results.innerHTML = '<p class="success">‚úì VideoSDK already loaded</p>';
                return;
            }
            
            const script = document.createElement('script');
            script.src = "https://sdk.videosdk.live/rtc-js-prebuilt/0.3.31/rtc-js-prebuilt.js";
            script.async = true;
            
            script.onerror = function(event) {
                results.innerHTML = '<p class="error">‚ùå Failed to load VideoSDK script</p>';
            };
            
            script.onload = function() {
                let html = '<h3>VideoSDK Loading Test Results:</h3>';
                
                setTimeout(function() {
                    try {
                        html += '<p class="success">‚úì VideoSDK script loaded successfully</p>';
                        html += '<p class="' + (typeof VideoSDKMeeting !== 'undefined' ? 'success' : 'error') + '">VideoSDKMeeting class: ' + (typeof VideoSDKMeeting !== 'undefined' ? '‚úì Available' : '‚ùå Not available') + '</p>';
                        
                        if (typeof VideoSDKMeeting !== 'undefined') {
                            // Test creating meeting config (without actually connecting)
                            try {
                                const testConfig = {
                                    containerId: 'video-grid',
                                    meetingId: 'test-meeting-123',
                                    name: 'Test User',
                                    apiKey: videoSdkConfig.apiKey,
                                    token: videoSdkConfig.token,
                                    micEnabled: false,
                                    webcamEnabled: false,
                                    joinScreen: { visible: false }
                                };
                                
                                html += '<p class="success">‚úì Meeting configuration structure is valid</p>';
                                html += '<pre>' + JSON.stringify(testConfig, null, 2) + '</pre>';
                                
                                // Note: We don't actually create the meeting to avoid API calls
                                html += '<p class="warning">‚ö†Ô∏è Actual meeting creation skipped (test environment)</p>';
                                
                            } catch (configError) {
                                html += '<p class="error">‚ùå Meeting configuration error: ' + configError.message + '</p>';
                            }
                        }
                        
                        html += '<p class="success">‚úÖ VideoSDK loading test completed</p>';
                        
                    } catch (error) {
                        html += '<p class="error">‚ùå VideoSDK test failed: ' + error.message + '</p>';
                    }
                    
                    results.innerHTML = html;
                }, 1000);
            };
            
            document.body.appendChild(script);
        }

        function testErrorHandling() {
            const results = document.getElementById('error-test-results');
            let html = '<h3>Error Handling Test Results:</h3>';
            
            try {
                // Test 1: Trigger module system error (should be caught)
                html += '<h4>Module System Error Handling:</h4>';
                
                let moduleErrorCaught = false;
                const originalError = console.error;
                console.error = function(...args) {
                    if (args[0] && args[0].includes && args[0].includes('exports is not defined')) {
                        moduleErrorCaught = true;
                    }
                    originalError.apply(console, args);
                };
                
                try {
                    // This should trigger a module error that gets caught by our handler
                    eval('someNonExistentExports.test = "hello";');
                } catch (e) {
                    // This error should be handled by our polyfills
                    html += '<p class="success">‚úì Module error properly caught and handled</p>';
                }
                
                console.error = originalError;
                
                // Test 2: Test our error handler function (if available)
                if (typeof handleError === 'function') {
                    html += '<p class="success">‚úì handleError function is available</p>';
                } else {
                    html += '<p class="warning">‚ö†Ô∏è handleError function not available (expected in voice-section context)</p>';
                }
                
                // Test 3: Test configuration validation
                html += '<h4>Configuration Validation:</h4>';
                const testConfigs = [
                    { apiKey: null, token: 'test-token' },
                    { apiKey: 'test-key', token: null },
                    { apiKey: '', token: '' },
                    null
                ];
                
                testConfigs.forEach((config, index) => {
                    try {
                        if (!config || !config.apiKey || !config.token) {
                            html += '<p class="success">‚úì Test config ' + (index + 1) + ' properly detected as invalid</p>';
                        } else {
                            html += '<p class="warning">‚ö†Ô∏è Test config ' + (index + 1) + ' validation needs improvement</p>';
                        }
                    } catch (e) {
                        html += '<p class="error">‚ùå Test config ' + (index + 1) + ' validation failed: ' + e.message + '</p>';
                    }
                });
                
                html += '<p class="success">‚úÖ Error handling test completed</p>';
                
            } catch (error) {
                html += '<p class="error">‚ùå Error handling test failed: ' + error.message + '</p>';
            }
            
            results.innerHTML = html;
        }

        // Run initial tests
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                testModuleSystem();
                testConfiguration();
            }, 500);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="user-id" content="123">
    <meta name="username" content="TestUser">
    <meta name="user-avatar" content="/public/assets/common/default-profile-picture.png">
    <title>Voice System Test</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/voice-call-section.css">
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Voice System Functionality Test</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Status Panel -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4">System Status</h2>
                <div id="status-info" class="text-sm">
                    <div>Loading...</div>
                </div>
            </div>
            
            <!-- Controls Panel -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-bold mb-4">Voice Controls</h2>
                <div class="flex gap-3 mb-4">
                    <button id="micBtn" class="voice-control-btn w-10 h-10 rounded-full bg-[#4f545c] hover:bg-[#3ba55c] text-white transition-all duration-150 flex items-center justify-center">
                        <i class="fas fa-microphone-slash text-sm"></i>
                    </button>
                    <button id="videoBtn" class="voice-control-btn w-10 h-10 rounded-full bg-[#4f545c] hover:bg-[#3ba55c] text-white transition-all duration-150 flex items-center justify-center">
                        <i class="fas fa-video-slash text-sm"></i>
                    </button>
                    <button id="screenBtn" class="voice-control-btn screen-btn w-10 h-10 rounded-full bg-[#4f545c] hover:bg-[#5865f2] text-white transition-all duration-150 flex items-center justify-center">
                        <i class="fas fa-desktop text-sm"></i>
                    </button>
                    <button id="deafenBtn" class="voice-control-btn w-10 h-10 rounded-full bg-[#4f545c] hover:bg-[#ed4245] text-white transition-all duration-150 flex items-center justify-center">
                        <i class="fas fa-headphones text-sm"></i>
                    </button>
                </div>
                
                <div class="space-y-2">
                    <button id="join-voice" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded w-full">Join Voice Channel</button>
                    <button id="leave-voice" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded w-full">Leave Voice Channel</button>
                    <button id="test-video" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded w-full">Test Video Toggle</button>
                    <button id="test-screen" class="bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded w-full">Test Screen Share</button>
                    <button id="run-diagnostic" class="bg-yellow-500 hover:bg-yellow-600 px-4 py-2 rounded w-full text-black">Run Full Diagnostic</button>
                </div>
            </div>
        </div>
        
        <!-- Voice Call Section -->
        <div class="bg-gray-800 p-6 rounded-lg mb-6">
            <h2 class="text-xl font-bold mb-4">Voice Call Participants</h2>
            <div id="voice-participants-grid" class="voice-participants-grid">
                <!-- Participants will appear here -->
            </div>
        </div>
        
        <!-- Log Panel -->
        <div class="bg-gray-800 p-6 rounded-lg">
            <h2 class="text-xl font-bold mb-4">System Log</h2>
            <div id="system-log" class="bg-gray-900 p-4 rounded text-sm max-h-80 overflow-y-auto font-mono">
                <div class="text-green-400">[INIT] Test page loaded</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/components/voice/voice-events.js"></script>
    <script src="js/components/voice/voice-manager.js"></script>
    <script src="js/components/voice/voice-facade.js"></script>
    <script src="js/components/voice/voice-call-section.js"></script>
    <script src="js/diagnose-voice-system.js"></script>
    
    <script>
        let testChannelId = 'test-channel-456';
        let testChannelName = 'Test Voice Channel';
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('system-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : 
                         type === 'success' ? 'text-green-400' : 
                         type === 'warning' ? 'text-yellow-400' : 'text-gray-300';
            
            logElement.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateStatus() {
            const statusDiv = document.getElementById('status-info');
            const vm = window.voiceManager;
            
            if (!vm) {
                statusDiv.innerHTML = '<div class="text-red-400">❌ VoiceManager not available</div>';
                return;
            }
            
            statusDiv.innerHTML = `
                <div class="space-y-1">
                    <div>VoiceManager: <span class="text-green-400">✅ Available</span></div>
                    <div>Connected: <span class="${vm.isConnected ? 'text-green-400' : 'text-red-400'}">${vm.isConnected ? '✅ Yes' : '❌ No'}</span></div>
                    <div>Meeting Joined: <span class="${vm.isMeetingJoined ? 'text-green-400' : 'text-red-400'}">${vm.isMeetingJoined ? '✅ Yes' : '❌ No'}</span></div>
                    <div>Channel: <span class="text-blue-400">${vm.currentChannelId || 'None'}</span></div>
                    <div>Meeting ID: <span class="text-blue-400">${vm.currentMeetingId || 'None'}</span></div>
                    <div>Local Participant: <span class="${vm.localParticipant ? 'text-green-400' : 'text-red-400'}">${vm.localParticipant ? '✅ Yes' : '❌ No'}</span></div>
                    <div>Participants: <span class="text-blue-400">${vm.participants.size}</span></div>
                    <div class="mt-2 pt-2 border-t border-gray-600">
                        <div>Mic: <span class="${vm.getMicState() ? 'text-green-400' : 'text-red-400'}">${vm.getMicState() ? 'ON' : 'OFF'}</span></div>
                        <div>Video: <span class="${vm.getVideoState() ? 'text-green-400' : 'text-red-400'}">${vm.getVideoState() ? 'ON' : 'OFF'}</span></div>
                        <div>Screen: <span class="${vm.getScreenShareState() ? 'text-green-400' : 'text-red-400'}">${vm.getScreenShareState() ? 'ON' : 'OFF'}</span></div>
                    </div>
                </div>
            `;
        }
        
        // Event listeners
        document.getElementById('join-voice').addEventListener('click', async () => {
            log('Attempting to join voice channel...', 'info');
            try {
                if (window.voiceFacade) {
                    await window.voiceFacade.join(testChannelId, testChannelName);
                    log('Successfully joined voice channel', 'success');
                } else {
                    log('VoiceFacade not available', 'error');
                }
            } catch (error) {
                log(`Failed to join voice: ${error.message}`, 'error');
            }
            updateStatus();
        });
        
        document.getElementById('leave-voice').addEventListener('click', async () => {
            log('Leaving voice channel...', 'info');
            try {
                if (window.voiceFacade) {
                    await window.voiceFacade.leave();
                    log('Successfully left voice channel', 'success');
                } else {
                    log('VoiceFacade not available', 'error');
                }
            } catch (error) {
                log(`Failed to leave voice: ${error.message}`, 'error');
            }
            updateStatus();
        });
        
        document.getElementById('test-video').addEventListener('click', async () => {
            log('Testing video toggle...', 'info');
            try {
                if (window.voiceManager) {
                    const newState = await window.voiceManager.toggleVideo();
                    log(`Video toggled to: ${newState ? 'ON' : 'OFF'}`, 'success');
                } else {
                    log('VoiceManager not available', 'error');
                }
            } catch (error) {
                log(`Video toggle failed: ${error.message}`, 'error');
            }
            updateStatus();
        });
        
        document.getElementById('test-screen').addEventListener('click', async () => {
            log('Testing screen share toggle...', 'info');
            try {
                if (window.voiceManager) {
                    const newState = await window.voiceManager.toggleScreenShare();
                    log(`Screen share toggled to: ${newState ? 'ON' : 'OFF'}`, 'success');
                } else {
                    log('VoiceManager not available', 'error');
                }
            } catch (error) {
                log(`Screen share toggle failed: ${error.message}`, 'error');
            }
            updateStatus();
        });
        
        document.getElementById('run-diagnostic').addEventListener('click', () => {
            log('Running full diagnostic...', 'info');
            if (window.diagnoseVoiceSystem) {
                const result = window.diagnoseVoiceSystem();
                log(`Diagnostic completed: ${result.status}`, result.status === 'completed' ? 'success' : 'error');
            } else {
                log('Diagnostic function not available', 'error');
            }
        });
        
        // Initialize
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateStatus();
                log('Test page initialized', 'success');
                
                // Set up periodic status updates
                setInterval(updateStatus, 2000);
            }, 1000);
        });
        
        // Listen for voice events
        window.addEventListener('voiceConnect', (e) => {
            log(`Voice connected to channel: ${e.detail.channelName}`, 'success');
            updateStatus();
        });
        
        window.addEventListener('voiceDisconnect', (e) => {
            log('Voice disconnected', 'warning');
            updateStatus();
        });
        
        window.addEventListener('voiceStateChanged', (e) => {
            log(`Voice state changed: ${e.detail.type} = ${e.detail.state}`, 'info');
            updateStatus();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Functionality Test - Reply & Music</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1e1e1e;
            color: #ffffff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .test-button {
            background: #5865f2;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button:hover {
            background: #4752c4;
        }
        .error {
            color: #ff6b6b;
        }
        .success {
            color: #51cf66;
        }
        .warning {
            color: #ffd43b;
        }
        .test-results {
            background: #111;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .reply-demo {
            background: #36393f;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        .bubble-reply-container {
            display: flex;
            align-items: center;
            background: rgba(79, 84, 92, 0.16);
            border-left: 4px solid #5865f2;
            border-radius: 3px;
            padding: 4px 8px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 12px;
            color: #b9bbbe;
        }
        .bubble-reply-username {
            font-weight: 500;
            color: #5865f2;
            margin-right: 4px;
        }
        .bubble-reply-content {
            color: #dcddde;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <h1>ü§ñ Bot Functionality Test Suite</h1>
    <p>Comprehensive test for bot reply display and music command processing</p>

    <div class="test-section">
        <h2>üîÑ Reply Message Display Test</h2>
        <p>Testing if bot replies show correctly with proper reply UI</p>
        
        <button class="test-button" onclick="testReplyDisplay()">Test Reply Display</button>
        <button class="test-button" onclick="simulateBotReply()">Simulate Bot Reply</button>
        
        <div id="reply-test-results" class="test-results"></div>
        
        <div class="reply-demo">
            <h4>Expected Reply UI:</h4>
            <div class="bubble-reply-container">
                <div style="margin-right: 4px;">
                    <i class="fas fa-reply" style="font-size: 10px; color: #72767d;"></i>
                </div>
                <span class="bubble-reply-username">TestUser</span>
                <span class="bubble-reply-content">/titibot play never gonna give you up</span>
            </div>
            <div style="background: #40444b; padding: 8px; border-radius: 3px;">
                <strong>TitiBot:</strong> üéµ MUSIGGGGGGG: "never gonna give you up" - Searching and playing...
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>üéµ Music Command Processing Test</h2>
        <p>Testing if bot music commands are processed and music player responds</p>
        
        <button class="test-button" onclick="testMusicSystem()">Test Music System</button>
        <button class="test-button" onclick="simulateMusicCommand()">Simulate Music Command</button>
        <button class="test-button" onclick="debugMusicPlayer()">Debug Music Player</button>
        
        <div id="music-test-results" class="test-results"></div>
    </div>

    <div class="test-section">
        <h2>üîç System Status</h2>
        <button class="test-button" onclick="checkSystemStatus()">Check System Status</button>
        <div id="system-status" class="test-results"></div>
    </div>

    <div class="test-section">
        <h2>üß™ Integration Test</h2>
        <p>End-to-end test: Send bot command ‚Üí Receive reply ‚Üí Process music</p>
        <button class="test-button" onclick="runIntegrationTest()">Run Integration Test</button>
        <div id="integration-results" class="test-results"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testReplyDisplay() {
            clearLog('reply-test-results');
            log('reply-test-results', 'üîÑ Testing reply display functionality...', 'info');

            try {
                // Test 1: Check if message handler exists
                if (typeof window.MessageHandler !== 'undefined') {
                    log('reply-test-results', '‚úÖ MessageHandler class found', 'success');
                } else {
                    log('reply-test-results', '‚ùå MessageHandler class not found', 'error');
                }

                // Test 2: Test createReplyContainer method
                const testMessageData = {
                    id: 'test-123',
                    reply_message_id: 'original-456',
                    reply_data: {
                        message_id: 'original-456',
                        content: '/titibot play test song',
                        user_id: 1,
                        username: 'TestUser',
                        avatar_url: '/assets/default-avatar.png'
                    }
                };

                // Simulate creating reply container
                const replyContainer = document.createElement('div');
                replyContainer.className = 'bubble-reply-container';
                replyContainer.innerHTML = `
                    <div style="margin-right: 4px;">
                        <i class="fas fa-reply" style="font-size: 10px; color: #72767d;"></i>
                    </div>
                    <span class="bubble-reply-username">${testMessageData.reply_data.username}</span>
                    <span class="bubble-reply-content">${testMessageData.reply_data.content}</span>
                `;

                if (replyContainer) {
                    log('reply-test-results', '‚úÖ Reply container created successfully', 'success');
                    log('reply-test-results', `‚úÖ Reply data: ${testMessageData.reply_data.username} - ${testMessageData.reply_data.content}`, 'info');
                } else {
                    log('reply-test-results', '‚ùå Failed to create reply container', 'error');
                }

                // Test 3: Check CSS styles
                const testStyles = window.getComputedStyle(replyContainer);
                if (testStyles.display === 'flex') {
                    log('reply-test-results', '‚úÖ Reply container has proper flex display', 'success');
                } else {
                    log('reply-test-results', '‚ö†Ô∏è Reply container may not have proper styling', 'warning');
                }

                log('reply-test-results', '‚úÖ Reply display test completed', 'success');

            } catch (error) {
                log('reply-test-results', `‚ùå Reply test failed: ${error.message}`, 'error');
            }
        }

        async function simulateBotReply() {
            clearLog('reply-test-results');
            log('reply-test-results', 'ü§ñ Simulating bot reply...', 'info');

            try {
                // Simulate a bot reply message
                const mockBotReply = {
                    id: 'bot-reply-' + Date.now(),
                    user_id: 4,
                    username: 'titibot',
                    avatar_url: '/public/assets/common/default-profile-picture.png',
                    content: 'üéµ MUSIGGGGGGG: "test song" - Searching and playing...',
                    sent_at: new Date().toISOString(),
                    type: 'text',
                    message_type: 'text',
                    is_bot: true,
                    bot_id: 4,
                    reply_message_id: 'original-123',
                    reply_data: {
                        message_id: 'original-123',
                        content: '/titibot play test song',
                        user_id: 1,
                        username: 'TestUser',
                        avatar_url: '/public/assets/common/default-profile-picture.png'
                    },
                    music_data: {
                        action: 'play',
                        query: 'test song',
                        track: {
                            title: 'test song',
                            artist: 'Searching...',
                            previewUrl: null
                        }
                    }
                };

                log('reply-test-results', '‚úÖ Mock bot reply created', 'success');
                log('reply-test-results', `üìù Bot reply content: ${mockBotReply.content}`, 'info');
                log('reply-test-results', `üîó Replying to: ${mockBotReply.reply_data.username} - ${mockBotReply.reply_data.content}`, 'info');
                log('reply-test-results', `üéµ Music data: ${JSON.stringify(mockBotReply.music_data)}`, 'info');

                // If socket is available, emit the message
                if (window.globalSocketManager && window.globalSocketManager.io) {
                    log('reply-test-results', 'üì° Emitting bot reply via socket...', 'info');
                    window.globalSocketManager.io.emit('new-channel-message', mockBotReply);
                    log('reply-test-results', '‚úÖ Bot reply sent via socket', 'success');
                } else {
                    log('reply-test-results', '‚ö†Ô∏è Socket not available for testing', 'warning');
                }

            } catch (error) {
                log('reply-test-results', `‚ùå Bot reply simulation failed: ${error.message}`, 'error');
            }
        }

        async function testMusicSystem() {
            clearLog('music-test-results');
            log('music-test-results', 'üéµ Testing music system...', 'info');

            try {
                // Test 1: Check if music player exists
                if (window.musicPlayer) {
                    log('music-test-results', '‚úÖ Music player found', 'success');
                    log('music-test-results', `üìä Music player initialized: ${window.musicPlayer.initialized}`, 'info');
                } else {
                    log('music-test-results', '‚ùå Music player not found', 'error');
                    return;
                }

                // Test 2: Check if music player is initialized
                if (!window.musicPlayer.initialized) {
                    log('music-test-results', 'üîÑ Initializing music player...', 'info');
                    window.musicPlayer.forceInitialize();
                    log('music-test-results', '‚úÖ Music player initialized', 'success');
                }

                // Test 3: Check audio context
                if (window.musicPlayer._audioContext) {
                    log('music-test-results', `‚úÖ Audio context state: ${window.musicPlayer._audioContext.state}`, 'success');
                } else {
                    log('music-test-results', '‚ö†Ô∏è Audio context not available', 'warning');
                }

                // Test 4: Check socket listeners
                if (window.globalSocketManager && window.globalSocketManager.io) {
                    log('music-test-results', '‚úÖ Socket available for music commands', 'success');
                } else {
                    log('music-test-results', '‚ö†Ô∏è Socket not available', 'warning');
                }

                log('music-test-results', '‚úÖ Music system test completed', 'success');

            } catch (error) {
                log('music-test-results', `‚ùå Music system test failed: ${error.message}`, 'error');
            }
        }

        async function simulateMusicCommand() {
            clearLog('music-test-results');
            log('music-test-results', 'üéµ Simulating music command...', 'info');

            try {
                const mockMusicCommand = {
                    channel_id: 1,
                    room_id: null,
                    music_data: {
                        action: 'play',
                        query: 'never gonna give you up',
                        track: {
                            title: 'never gonna give you up',
                            artist: 'Rick Astley'
                        }
                    },
                    bot_id: 4,
                    timestamp: Date.now()
                };

                log('music-test-results', 'üìù Mock music command created', 'info');
                log('music-test-results', `üéµ Action: ${mockMusicCommand.music_data.action}`, 'info');
                log('music-test-results', `üîç Query: ${mockMusicCommand.music_data.query}`, 'info');

                // Test direct music player command processing
                if (window.musicPlayer && window.musicPlayer.processBotMusicCommand) {
                    log('music-test-results', 'üîÑ Processing music command...', 'info');
                    await window.musicPlayer.processBotMusicCommand(mockMusicCommand);
                    log('music-test-results', '‚úÖ Music command processed', 'success');
                } else {
                    log('music-test-results', '‚ùå Music player command processing not available', 'error');
                }

                // Test socket emission
                if (window.globalSocketManager && window.globalSocketManager.io) {
                    log('music-test-results', 'üì° Emitting music command via socket...', 'info');
                    window.globalSocketManager.io.emit('bot-music-command', mockMusicCommand);
                    log('music-test-results', '‚úÖ Music command sent via socket', 'success');
                } else {
                    log('music-test-results', '‚ö†Ô∏è Socket not available for music command', 'warning');
                }

            } catch (error) {
                log('music-test-results', `‚ùå Music command simulation failed: ${error.message}`, 'error');
            }
        }

        async function debugMusicPlayer() {
            clearLog('music-test-results');
            log('music-test-results', 'üîç Debugging music player...', 'info');

            try {
                if (window.musicPlayer) {
                    log('music-test-results', `üìä Player State:`, 'info');
                    log('music-test-results', `   - Initialized: ${window.musicPlayer.initialized}`, 'info');
                    log('music-test-results', `   - Is Playing: ${window.musicPlayer.isPlaying}`, 'info');
                    log('music-test-results', `   - Current Song: ${window.musicPlayer.currentSong ? window.musicPlayer.currentSong.title : 'None'}`, 'info');
                    log('music-test-results', `   - Queue Length: ${window.musicPlayer.queue ? window.musicPlayer.queue.length : 0}`, 'info');
                    
                    if (window.musicPlayer._audioContext) {
                        log('music-test-results', `   - Audio Context State: ${window.musicPlayer._audioContext.state}`, 'info');
                    }
                    
                    if (window.musicPlayer.audio) {
                        log('music-test-results', `   - Audio Ready State: ${window.musicPlayer.audio.readyState}`, 'info');
                        log('music-test-results', `   - Audio Network State: ${window.musicPlayer.audio.networkState}`, 'info');
                        log('music-test-results', `   - Audio Source: ${window.musicPlayer.audio.src || 'None'}`, 'info');
                    }

                    // Test search function
                    log('music-test-results', 'üîç Testing search function...', 'info');
                    const searchResult = await window.musicPlayer.searchMusic('test');
                    if (searchResult) {
                        log('music-test-results', `‚úÖ Search successful: ${searchResult.title}`, 'success');
                    } else {
                        log('music-test-results', '‚ö†Ô∏è Search returned no results', 'warning');
                    }

                } else {
                    log('music-test-results', '‚ùå Music player not available', 'error');
                }

            } catch (error) {
                log('music-test-results', `‚ùå Music player debug failed: ${error.message}`, 'error');
            }
        }

        async function checkSystemStatus() {
            clearLog('system-status');
            log('system-status', 'üîç Checking system status...', 'info');

            try {
                // Check key components
                const components = {
                    'Global Socket Manager': !!window.globalSocketManager,
                    'Music Player': !!window.musicPlayer,
                    'Bot Component': !!window.BotComponent,
                    'Message Handler': !!window.MessageHandler,
                    'Voice Call Section': !!window.voiceCallSection
                };

                for (const [name, exists] of Object.entries(components)) {
                    log('system-status', `${exists ? '‚úÖ' : '‚ùå'} ${name}: ${exists ? 'Available' : 'Not Found'}`, exists ? 'success' : 'error');
                }

                // Check socket connection
                if (window.globalSocketManager) {
                    const isConnected = window.globalSocketManager.isReady();
                    log('system-status', `üîå Socket Connection: ${isConnected ? 'Connected' : 'Disconnected'}`, isConnected ? 'success' : 'error');
                }

                // Check audio context
                if (window.AudioContext || window.webkitAudioContext) {
                    log('system-status', '‚úÖ Audio Context Support: Available', 'success');
                } else {
                    log('system-status', '‚ùå Audio Context Support: Not Available', 'error');
                }

                // Check current page
                log('system-status', `üìç Current Page: ${window.location.pathname}`, 'info');
                log('system-status', `üåê User Agent: ${navigator.userAgent}`, 'info');

            } catch (error) {
                log('system-status', `‚ùå System status check failed: ${error.message}`, 'error');
            }
        }

        async function runIntegrationTest() {
            clearLog('integration-results');
            log('integration-results', 'üß™ Running integration test...', 'info');

            try {
                // Step 1: Initialize components
                log('integration-results', '1Ô∏è‚É£ Initializing components...', 'info');
                
                if (!window.musicPlayer) {
                    log('integration-results', '‚ùå Music player not available', 'error');
                    return;
                }

                if (!window.musicPlayer.initialized) {
                    window.musicPlayer.forceInitialize();
                    log('integration-results', '‚úÖ Music player initialized', 'success');
                }

                // Step 2: Simulate bot command
                log('integration-results', '2Ô∏è‚É£ Simulating bot command...', 'info');
                
                const originalMessage = {
                    id: 'original-' + Date.now(),
                    user_id: 1,
                    username: 'TestUser',
                    content: '/titibot play test song',
                    channel_id: 1,
                    avatar_url: '/public/assets/common/default-profile-picture.png'
                };

                // Step 3: Create bot reply
                log('integration-results', '3Ô∏è‚É£ Creating bot reply...', 'info');
                
                const botReply = {
                    id: 'bot-reply-' + Date.now(),
                    user_id: 4,
                    username: 'titibot',
                    avatar_url: '/public/assets/common/default-profile-picture.png',
                    content: 'üéµ MUSIGGGGGGG: "test song" - Searching and playing...',
                    sent_at: new Date().toISOString(),
                    type: 'text',
                    message_type: 'text',
                    is_bot: true,
                    bot_id: 4,
                    reply_message_id: originalMessage.id,
                    reply_data: {
                        message_id: originalMessage.id,
                        content: originalMessage.content,
                        user_id: originalMessage.user_id,
                        username: originalMessage.username,
                        avatar_url: originalMessage.avatar_url
                    },
                    music_data: {
                        action: 'play',
                        query: 'test song',
                        track: {
                            title: 'test song',
                            artist: 'Test Artist'
                        }
                    }
                };

                log('integration-results', '‚úÖ Bot reply created with reply data', 'success');

                // Step 4: Process music command
                log('integration-results', '4Ô∏è‚É£ Processing music command...', 'info');
                
                const musicCommand = {
                    channel_id: 1,
                    music_data: botReply.music_data,
                    bot_id: 4,
                    timestamp: Date.now()
                };

                await window.musicPlayer.processBotMusicCommand(musicCommand);
                log('integration-results', '‚úÖ Music command processed', 'success');

                // Step 5: Test complete
                log('integration-results', 'üéâ Integration test completed successfully!', 'success');
                log('integration-results', 'üìã Summary:', 'info');
                log('integration-results', '   ‚úÖ Bot reply with correct reply_data structure', 'success');
                log('integration-results', '   ‚úÖ Music command processing working', 'success');
                log('integration-results', '   ‚úÖ All components integrated properly', 'success');

            } catch (error) {
                log('integration-results', `‚ùå Integration test failed: ${error.message}`, 'error');
                console.error('Integration test error:', error);
            }
        }

        // Auto-run system status check on page load
        window.addEventListener('load', () => {
            setTimeout(checkSystemStatus, 1000);
        });
    </script>
</body>
</html> 
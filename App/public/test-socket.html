<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TitiBot Ping Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #2c2f33;
            color: #fff;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 5px; 
            background: #5865f2; 
            color: white; 
            cursor: pointer; 
        }
        button:hover { 
            background: #4752c4; 
        }
        .log { 
            background: #36393f; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0; 
            height: 400px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px;
        }
        .log-entry { 
            margin: 2px 0; 
            padding: 2px 5px; 
        }
        .log-info { color: #00d4aa; }
        .log-success { color: #57f287; }
        .log-error { color: #ed4245; }
        .log-warning { color: #fee75c; }
        input { 
            padding: 8px; 
            margin: 5px; 
            border: 1px solid #555; 
            border-radius: 3px; 
            background: #40444b;
            color: #fff;
            width: 300px;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <h1>ü§ñ TitiBot Test Panel</h1>
        
        <div>
            <button onclick="connectSocket()">Connect Socket</button>
            <button onclick="testPing()">Test Ping</button>
            <button onclick="testHelp()">Test Help</button>
            <button onclick="clearLog()">Clear Log</button>
            <br>
            <input type="text" id="customCommand" placeholder="Enter custom command" value="/titibot ping">
            <button onclick="sendCustomCommand()">Send Custom</button>
        </div>
        
        <div class="log" id="logContainer"></div>
        
        <div>
            <h3>Connection Status</h3>
            <p>Socket ID: <span id="socketId">Not connected</span></p>
            <p>User ID: <span id="userId">Not set</span></p>
            <p>Username: <span id="username">Not set</span></p>
            <p>Target Channel: <span id="targetChannel">13</span></p>
        </div>
    </div>

    <script>
        let socket = null;
        let authenticated = false;
        const testUserId = 1;
        const testUsername = 'testuser';  
        const testChannelId = '13';

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function connectSocket() {
            if (socket) {
                socket.disconnect();
            }

            log('üîå Connecting to socket server...', 'info');
            
            socket = io('http://localhost:1002', {
                path: '/socket.io',
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                log('‚úÖ Socket connected: ' + socket.id, 'success');
                document.getElementById('socketId').textContent = socket.id;
                
                log('üîê Authenticating...', 'info');
                socket.emit('authenticate', {
                    user_id: testUserId,
                    username: testUsername
                });
            });

            socket.on('auth-success', (data) => {
                log('‚úÖ Authentication successful', 'success');
                authenticated = true;
                document.getElementById('userId').textContent = testUserId;
                document.getElementById('username').textContent = testUsername;
                
                socket.emit('join-channel', { channel_id: testChannelId });
                
                log('üé§ Simulating voice channel join...', 'info');
                socket.emit('register-voice-meeting', {
                    channel_id: testChannelId,
                    meeting_id: `voice_channel_${testChannelId}`
                });
            });

            socket.on('auth-error', (data) => {
                log('‚ùå Authentication failed: ' + data.message, 'error');
            });

            socket.on('voice-meeting-update', (data) => {
                if (data.action === 'join') {
                    log('üé§ Successfully joined voice channel ' + data.channel_id, 'success');
                } else {
                    log('üé§ Voice meeting update: ' + data.action, 'info');
                }
            });

            socket.on('new-channel-message', (data) => {
                if (data.is_bot) {
                    log(`ü§ñ Bot Response: "${data.content}"`, 'success');
                } else {
                    log(`üí¨ Message: "${data.content}" from ${data.username}`, 'info');
                }
            });

            socket.on('bot-voice-participant-joined', (data) => {
                log(`ü§ñüéµ Bot joined voice: ${data.participant?.username}`, 'success');
            });

            socket.on('bot-voice-participant-left', (data) => {
                log(`ü§ñüëã Bot left voice: ${data.participant?.username}`, 'warning');
            });

            socket.on('bot-music-command', (data) => {
                log(`üéµ Bot Music Command: ${data.music_data?.action}`, 'success');
            });

            socket.on('disconnect', () => {
                log('üîå Socket disconnected', 'warning');
                authenticated = false;
            });

            socket.on('connect_error', (error) => {
                log('‚ùå Connection error: ' + error.message, 'error');
            });
        }

        function testPing() {
            if (!socket || !authenticated) {
                log('‚ùå Not connected or authenticated', 'error');
                return;
            }

            log('üèì Testing ping command...', 'info');
            sendMessage('/titibot ping');
        }

        function testHelp() {
            if (!socket || !authenticated) {
                log('‚ùå Not connected or authenticated', 'error');
                return;
            }

            log('‚ùì Testing help command...', 'info');
            sendMessage('/titibot help');
        }

        function sendCustomCommand() {
            const command = document.getElementById('customCommand').value;
            if (!command) {
                log('‚ùå No command entered', 'error');
                return;
            }

            if (!socket || !authenticated) {
                log('‚ùå Not connected or authenticated', 'error');
                return;
            }

            log(`üì§ Sending custom command: ${command}`, 'info');
            sendMessage(command);
        }

        function sendMessage(content) {
            const messageData = {
                content: content,
                target_type: 'channel',
                target_id: testChannelId,
                message_type: 'text',
                attachments: [],
                mentions: [],
                temp_message_id: `temp-${Date.now()}`
            };

            const isTitiBotCommand = content.toLowerCase().includes('/titibot');
            if (isTitiBotCommand) {
                messageData.voice_context = {
                    voice_channel_id: testChannelId,
                    user_in_voice: true
                };
                log(`üé§ Added voice context: channel ${testChannelId}`, 'info');
            }

            socket.emit('save-and-send-message', messageData);
            log(`üì§ Sent: "${content}"`, 'info');
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }

        window.addEventListener('load', () => {
            log('üöÄ TitiBot Voice Test Panel loaded', 'info');
            log('üìù Click "Connect Socket" to start testing', 'info');
            log('üé§ This test will simulate being in voice channel 13', 'info');
        });
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Auto-Join Test</title>
    <link rel="stylesheet" href="/public/css/voice-section.css">
    <meta name="channel-id" content="test-channel-123">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2b2d31;
            color: white;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #313338;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        button {
            background-color: #5865f2;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background-color: #4752c4;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            background-color: #2b2d31;
            border-radius: 4px;
            min-height: 100px;
        }
        .log {
            font-family: monospace;
            font-size: 12px;
            color: #b5bac1;
            margin: 2px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Voice Auto-Join Test</h1>
        
        <div>
            <button id="setupTest">Setup Test</button>
            <button id="simulateChannelSelect">Simulate Channel Selection</button>
            <button id="clearStorage">Clear Storage</button>
            <button id="checkStatus">Check Status</button>
        </div>
        
        <div class="status" id="status">
            <div class="log">Status will appear here...</div>
        </div>
        
        <div id="voice-container" class="flex flex-col h-screen bg-[#313338] text-white voice-ui-element">
            <div id="mainContent" class="flex-1 flex flex-col">
                <div id="joinView" class="flex-1 flex flex-col items-center justify-center bg-gradient-to-b from-[#0a0a0f] via-[#1a1a2e] to-[#16213e] relative overflow-hidden">
                    <div class="relative z-10 text-center space-y-8 animate-fade-in-cosmic">
                        <div class="relative">
                            <h2 class="text-4xl font-bold text-white mb-2 drop-shadow-2xl tracking-wide">
                                Test Voice Channel
                            </h2>
                        </div>
                        
                        <p class="text-blue-100/90 text-lg drop-shadow-lg font-light tracking-wide">No one is currently exploring this space</p>
                        
                        <div class="">
                            <button id="joinBtn" class="relative transition-all duration-300 bg-gradient-to-r from-[#8b5cf6]/20 to-[#06b6d4]/20 border border-white/30 text-white font-semibold py-4 px-12 rounded-xl hover:scale-110">
                                <span class="relative z-10 flex items-center gap-3">
                                    <i class="fas fa-microphone text-xl"></i>
                                    Enter the voice channel
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="connectingView" class="flex-1 flex flex-col items-center justify-center bg-gradient-to-b from-[#0a0a0f] via-[#1a1a2e] to-[#16213e] hidden relative overflow-hidden">
                    <div class="relative z-10 text-center space-y-6">
                        <div class="relative">
                            <div class="animate-spin rounded-full h-16 w-16 border-2 border-transparent bg-gradient-to-r from-[#8b5cf6] via-[#06b6d4] to-[#6366f1] shadow-2xl"></div>
                        </div>
                        <p class="text-white text-xl font-light tracking-wide drop-shadow-lg animate-pulse-cosmic">Entering the cosmic void...</p>
                    </div>
                </div>
                
                <div id="videoGrid" class="hidden grid grid-cols-2 gap-4 mb-4"></div>
            </div>
            
            <div id="voiceControls" class="hidden">
                <div class="flex items-center justify-between h-13 bg-[#232428] px-3 w-full border-t border-[#1a1b1e]">
                    <div class="flex items-center space-x-1">
                        <button id="micBtn" class="mic-btn flex items-center justify-center h-8 w-8 rounded-md bg-transparent text-[#b5bac1] hover:bg-[#393c41] transition-colors" title="Mute">
                            <i class="fas fa-microphone text-sm"></i>
                        </button>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button id="leaveBtn" class="flex items-center justify-center h-8 w-8 rounded-md bg-[#ED4245] text-white hover:bg-[#a12d2f] transition-colors" title="Disconnect">
                            <i class="fas fa-phone-slash text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://sdk.videosdk.live/js-sdk/0.2.7/videosdk.js"></script>
    <script src="/public/js/components/voice/voice-section.js"></script>
    <script src="/public/js/components/voice/video-handler.js"></script>
    
    <script>
        // Mock voice manager for testing
        class MockVoiceManager {
            constructor() {
                this.isConnected = false;
                this.currentChannelId = null;
            }
            
            async init() {
                console.log('Mock voice manager initialized');
                return true;
            }
            
            async joinVoice() {
                console.log('Mock joining voice channel');
                this.isConnected = true;
                
                // Simulate a delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Dispatch connect event
                window.dispatchEvent(new CustomEvent('voiceConnect', {
                    detail: {
                        channelId: this.currentChannelId || 'test-channel-123',
                        channelName: 'Test Voice Channel',
                        meetingId: 'mock-meeting-id'
                    }
                }));
                
                return true;
            }
            
            leaveVoice() {
                console.log('Mock leaving voice channel');
                this.isConnected = false;
                
                // Dispatch disconnect event
                window.dispatchEvent(new CustomEvent('voiceDisconnect'));
                
                return true;
            }
        }
        
        // Status logging
        function log(message) {
            const status = document.getElementById('status');
            const logEntry = document.createElement('div');
            logEntry.className = 'log';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            status.appendChild(logEntry);
            
            // Scroll to bottom
            status.scrollTop = status.scrollHeight;
            
            console.log(message);
        }
        
        // Initialize test
        document.addEventListener('DOMContentLoaded', function() {
            log('Test page loaded');
            
            // Setup mock voice manager
            document.getElementById('setupTest').addEventListener('click', function() {
                window.voiceManager = new MockVoiceManager();
                window.voiceState = { isConnected: false };
                
                log('Mock voice manager set up');
                log('You can now test auto-join functionality');
            });
            
            // Simulate channel selection
            document.getElementById('simulateChannelSelect').addEventListener('click', function() {
                const channelId = 'test-channel-123';
                
                log(`Simulating selection of channel: ${channelId}`);
                
                // Set auto-join flags
                localStorage.setItem('autoJoinVoiceChannel', channelId);
                sessionStorage.setItem('forceAutoJoin', 'true');
                
                log('Auto-join flags set');
                log('Flags: ' + JSON.stringify({
                    autoJoinChannelId: localStorage.getItem('autoJoinVoiceChannel'),
                    forceAutoJoin: sessionStorage.getItem('forceAutoJoin')
                }));
                
                // Trigger auto-join check
                if (window.voiceSection) {
                    log('Triggering checkForAutoJoin method');
                    window.voiceSection.checkForAutoJoin();
                } else {
                    log('VoiceSection not initialized yet, initializing...');
                    window.voiceSection = new VoiceSection();
                }
            });
            
            // Clear storage
            document.getElementById('clearStorage').addEventListener('click', function() {
                localStorage.removeItem('autoJoinVoiceChannel');
                sessionStorage.removeItem('forceAutoJoin');
                localStorage.removeItem('voiceConnectionState');
                
                log('Storage cleared');
            });
            
            // Check status
            document.getElementById('checkStatus').addEventListener('click', function() {
                const status = {
                    autoJoinChannelId: localStorage.getItem('autoJoinVoiceChannel'),
                    forceAutoJoin: sessionStorage.getItem('forceAutoJoin'),
                    voiceConnectionState: localStorage.getItem('voiceConnectionState'),
                    voiceManagerExists: !!window.voiceManager,
                    voiceSectionExists: !!window.voiceSection,
                    joinBtnExists: !!document.getElementById('joinBtn'),
                    isConnected: window.voiceState?.isConnected || false
                };
                
                log('Current status: ' + JSON.stringify(status, null, 2));
            });
            
            // Handle join button
            const joinBtn = document.getElementById('joinBtn');
            if (joinBtn) {
                joinBtn.addEventListener('click', function() {
                    log('Join button clicked manually');
                });
            }
            
            // Handle leave button
            const leaveBtn = document.getElementById('leaveBtn');
            if (leaveBtn) {
                leaveBtn.addEventListener('click', function() {
                    log('Leave button clicked');
                    if (window.voiceManager) {
                        window.voiceManager.leaveVoice();
                    }
                });
            }
            
            // Listen for voice events
            window.addEventListener('voiceConnect', function(event) {
                log('Voice connected event received: ' + JSON.stringify(event.detail));
            });
            
            window.addEventListener('voiceDisconnect', function() {
                log('Voice disconnected event received');
            });
        });
    </script>
</body>
</html> 
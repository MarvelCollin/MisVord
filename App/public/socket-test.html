<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .info {
            background-color: #cce5ff;
            color: #004085;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            overflow: auto;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 8px;
        }
        button:hover {
            background-color: #0069d9;
        }
        #logs {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Socket.IO Connection Test</h1>
    
    <div class="info status">
        <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
        <p><strong>Hostname:</strong> <span id="hostname"></span></p>
        <p><strong>Environment:</strong> <span id="environment"></span></p>
    </div>
    
    <h2>Connection Status</h2>
    <div id="connectionStatus" class="warning status">
        Not connected
    </div>
    
    <h2>Connection Options</h2>
    <div>
        <div>
            <label for="socketUrl">Socket.IO Server URL:</label>
            <input type="text" id="socketUrl" style="width: 300px;">
        </div>
        <div style="margin-top: 10px;">
            <label for="socketPath">Socket.IO Path:</label>
            <input type="text" id="socketPath" style="width: 300px;">
        </div>
        <div style="margin-top: 10px;">
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn">Disconnect</button>
            <button id="checkPathsBtn">Check Socket.IO Paths</button>
        </div>
    </div>
    
    <h2>Logs</h2>
    <div id="logs"></div>
    
    <!-- Load Socket.IO dynamically -->
    <script>
        // Update environment information
        document.getElementById('currentUrl').textContent = window.location.href;
        document.getElementById('hostname').textContent = window.location.hostname;
        
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        document.getElementById('environment').textContent = isLocalhost ? 'Localhost' : 'Production';
        
        // Set default connection values
        if (isLocalhost) {
            document.getElementById('socketUrl').value = window.location.protocol + '//' + window.location.hostname + ':1002';
            document.getElementById('socketPath').value = '/socket.io';
        } else {
            document.getElementById('socketUrl').value = window.location.origin;
            document.getElementById('socketPath').value = '/socket.io';
        }
        
        // Log message function
        function log(message, type = 'info') {
            const logElement = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[${type}] ${message}`);
        }
        
        // Function to load Socket.IO
        function loadSocketIO(callback) {
            log('Loading Socket.IO client library...');
            
            // Check if Socket.IO is already loaded
            if (window.io) {
                log('Socket.IO already loaded', 'success');
                callback(null);
                return;
            }
            
            // Try to load from default path first
            const script = document.createElement('script');
            script.src = '/js/socket.io.min.js';
            script.onload = function() {
                log('Socket.IO loaded successfully from local path', 'success');
                callback(null);
            };
            script.onerror = function() {
                log('Failed to load Socket.IO from local path, trying CDN...', 'warning');
                
                // Fallback to CDN
                const cdnScript = document.createElement('script');
                cdnScript.src = 'https://cdn.socket.io/4.6.0/socket.io.min.js';
                cdnScript.onload = function() {
                    log('Socket.IO loaded successfully from CDN', 'success');
                    callback(null);
                };
                cdnScript.onerror = function() {
                    const error = 'Failed to load Socket.IO even from CDN!';
                    log(error, 'error');
                    callback(new Error(error));
                };
                document.head.appendChild(cdnScript);
            };
            document.head.appendChild(script);
        }
        
        // Global socket variable
        let socket = null;
        
        // Connect to Socket.IO server
        function connectToSocketIO() {
            const socketUrl = document.getElementById('socketUrl').value.trim();
            const socketPath = document.getElementById('socketPath').value.trim();
            
            if (!socketUrl) {
                log('Socket.IO server URL is required', 'error');
                return;
            }
            
            log(`Trying to connect to Socket.IO server at ${socketUrl} (path: ${socketPath})`);
            
            // Disconnect existing socket if any
            if (socket) {
                log('Disconnecting existing socket');
                socket.disconnect();
                socket = null;
            }
            
            // Set connection status
            const connectionStatus = document.getElementById('connectionStatus');
            connectionStatus.className = 'warning status';
            connectionStatus.textContent = 'Connecting...';
            
            // Create socket connection
            socket = io(socketUrl, {
                path: socketPath,
                transports: ['websocket', 'polling'],
                reconnectionAttempts: 3,
                reconnectionDelay: 1000,
                timeout: 5000,
                forceNew: true,
                query: { t: new Date().getTime() }
            });
            
            // Connection events
            socket.on('connect', () => {
                log(`Connected to Socket.IO server! ID: ${socket.id}`, 'success');
                connectionStatus.className = 'success status';
                connectionStatus.textContent = `Connected (ID: ${socket.id}, Transport: ${socket.io.engine.transport.name})`;
            });
            
            socket.on('disconnect', (reason) => {
                log(`Disconnected from Socket.IO server: ${reason}`, 'warning');
                connectionStatus.className = 'warning status';
                connectionStatus.textContent = `Disconnected: ${reason}`;
            });
            
            socket.on('connect_error', (error) => {
                log(`Socket.IO connection error: ${error.message}`, 'error');
                connectionStatus.className = 'error status';
                connectionStatus.textContent = `Connection error: ${error.message}`;
            });
            
            socket.on('error', (error) => {
                log(`Socket.IO error: ${error.message || error}`, 'error');
            });
        }
        
        // Function to check Socket.IO paths
        function checkSocketIOPaths() {
            log('Checking Socket.IO paths...');
            
            const paths = [
                '/js/socket.io.min.js',
                '/socket.io/socket.io.js'
            ];
            
            // Add custom path if we're testing a specific server
            const socketUrl = document.getElementById('socketUrl').value.trim();
            if (socketUrl && socketUrl !== window.location.origin) {
                paths.push(`${socketUrl}/socket.io/socket.io.js`);
            }
            
            // Check for localhost-specific paths
            if (isLocalhost) {
                paths.push('http://localhost:1002/socket.io/socket.io.js');
            }
            
            // Check each path
            paths.forEach(path => {
                fetch(path, { method: 'HEAD' })
                    .then(response => {
                        log(`Path ${path}: ${response.ok ? 'Found' : 'Not found'} (${response.status})`, 
                            response.ok ? 'success' : 'warning');
                    })
                    .catch(error => {
                        log(`Path ${path}: Error (${error.message})`, 'error');
                    });
            });
        }
        
        // Setup event handlers when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Load Socket.IO first
            loadSocketIO(function(error) {
                if (error) {
                    log('Could not load Socket.IO, connection test disabled', 'error');
                    document.getElementById('connectBtn').disabled = true;
                } else {
                    log('Ready to test Socket.IO connection', 'info');
                }
            });
            
            // Connect button
            document.getElementById('connectBtn').addEventListener('click', function() {
                connectToSocketIO();
            });
            
            // Disconnect button
            document.getElementById('disconnectBtn').addEventListener('click', function() {
                if (socket) {
                    socket.disconnect();
                    log('Manually disconnected from Socket.IO server', 'info');
                } else {
                    log('No active Socket.IO connection to disconnect', 'warning');
                }
            });
            
            // Check paths button
            document.getElementById('checkPathsBtn').addEventListener('click', function() {
                checkSocketIOPaths();
            });
        });
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Socket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a202c;
            color: white;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #38a169; }
        .error { background: #e53e3e; }
        .warning { background: #d69e2e; }
        .info { background: #3182ce; }
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #3182ce; }
        #log {
            background: #2d3748;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🧪 WebRTC Socket Connection Test</h1>
    
    <div id="status" class="status info">Ready to test</div>
    
    <button onclick="testSocketConnection()">Test Socket Connection</button>
    <button onclick="testWebRTCFeatures()">Test WebRTC Features</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <h3>Environment Info:</h3>
    <div id="envInfo"></div>
    
    <h3>Connection Log:</h3>
    <div id="log"></div>

    <script src="/js/socket.io.min.js"></script>
    <script>
        let socket = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.innerHTML = `<span style="color: #888">[${timestamp}]</span> ${message}`;
            entry.style.color = type === 'error' ? '#e53e3e' : type === 'success' ? '#38a169' : '#fff';
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function showEnvironmentInfo() {
            const envDiv = document.getElementById('envInfo');
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isDockerLocal = window.location.port === '1001';
            const isProduction = window.location.hostname.includes('marvelcollin.my.id');
            
            let socketUrl, socketPath;
            if (isProduction) {
                socketUrl = 'https://marvelcollin.my.id';
                socketPath = '/misvord/socket/socket.io';
            } else if (isDockerLocal) {
                socketUrl = window.location.origin.replace(':1001', ':1002');
                socketPath = '/socket.io';
            } else {
                socketUrl = 'http://localhost:1002';
                socketPath = '/socket.io';
            }
            
            envDiv.innerHTML = `
                <ul>
                    <li><strong>Hostname:</strong> ${window.location.hostname}</li>
                    <li><strong>Port:</strong> ${window.location.port}</li>
                    <li><strong>Protocol:</strong> ${window.location.protocol}</li>
                    <li><strong>Is Localhost:</strong> ${isLocalhost}</li>
                    <li><strong>Is Docker Local:</strong> ${isDockerLocal}</li>
                    <li><strong>Is Production:</strong> ${isProduction}</li>
                    <li><strong>Socket URL:</strong> ${socketUrl}</li>
                    <li><strong>Socket Path:</strong> ${socketPath}</li>
                </ul>
            `;
        }
        
        function testSocketConnection() {
            log('🔍 Starting socket connection test...', 'info');
            updateStatus('Testing socket connection...', 'info');
            
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const isDockerLocal = window.location.port === '1001';
            const isProduction = window.location.hostname.includes('marvelcollin.my.id');
            
            let socketUrl, socketPath;
            if (isProduction) {
                socketUrl = 'https://marvelcollin.my.id';
                socketPath = '/misvord/socket/socket.io';
            } else if (isDockerLocal) {
                socketUrl = window.location.origin.replace(':1001', ':1002');
                socketPath = '/socket.io';
            } else {
                socketUrl = 'http://localhost:1002';
                socketPath = '/socket.io';
            }
            
            log(`📡 Connecting to: ${socketUrl} with path: ${socketPath}`, 'info');
            
            try {
                socket = io(socketUrl, {
                    path: socketPath,
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    forceNew: true
                });
                
                socket.on('connect', () => {
                    log('✅ Socket connected successfully!', 'success');
                    log(`🆔 Socket ID: ${socket.id}`, 'info');
                    updateStatus('Connected to socket server', 'success');
                    
                    // Test joining a room
                    socket.emit('joinRoom', {
                        roomId: 'test-room',
                        userName: 'TestUser_' + Date.now()
                    });
                    
                    log('📤 Sent joinRoom request', 'info');
                });
                
                socket.on('joinedRoom', (data) => {
                    log(`🏠 Successfully joined room: ${JSON.stringify(data)}`, 'success');
                });
                
                socket.on('roomUsers', (users) => {
                    log(`👥 Room users: ${JSON.stringify(users)}`, 'info');
                });
                
                socket.on('disconnect', (reason) => {
                    log(`❌ Disconnected: ${reason}`, 'warning');
                    updateStatus('Disconnected from server', 'error');
                });
                
                socket.on('connect_error', (error) => {
                    log(`❌ Connection failed: ${error.message}`, 'error');
                    updateStatus('Connection failed', 'error');
                });
                
            } catch (error) {
                log(`❌ Error: ${error.message}`, 'error');
                updateStatus('Connection error', 'error');
            }
        }
        
        function testWebRTCFeatures() {
            log('🎥 Testing WebRTC features...', 'info');
            
            // Test MediaDevices API
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                log('✅ getUserMedia supported', 'success');
            } else {
                log('❌ getUserMedia not supported', 'error');
            }
            
            // Test RTCPeerConnection
            if (window.RTCPeerConnection) {
                log('✅ RTCPeerConnection supported', 'success');
            } else {
                log('❌ RTCPeerConnection not supported', 'error');
            }
            
            // Test Screen Sharing
            if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                log('✅ Screen sharing supported', 'success');
            } else {
                log('❌ Screen sharing not supported', 'error');
            }
            
            // Test Secure Context
            if (window.isSecureContext) {
                log('✅ Secure context detected', 'success');
            } else {
                log('⚠️ Insecure context - some features may not work', 'warning');
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            showEnvironmentInfo();
            log('🚀 WebRTC Socket Test initialized', 'info');
        });
    </script>
</body>
</html>

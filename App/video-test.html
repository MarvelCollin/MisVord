<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Video Test</title>
    <style>
        body {
            background: #2f3136;
            color: white;
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: #36393f;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .video-test {
            width: 300px;
            height: 200px;
            background: #000;
            border: 2px solid #5865f2;
            border-radius: 8px;
            margin: 10px;
            position: relative;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        .avatar {
            width: 60px;
            height: 60px;
            background: #5865f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        .participant-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 6px;
            overflow: hidden;
            z-index: 15;
        }
        .hidden {
            display: none;
        }
        button {
            background: #5865f2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #4752c4;
        }
        .status {
            background: #18191c;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Voice Video Stream Test</h1>
        
        <div class="test-section">
            <h2>Stream Detection Test</h2>
            <p>This tests the improved stream detection logic.</p>
            
            <div class="video-test" id="testParticipant">
                <div class="avatar">JD</div>
                <div class="participant-video hidden">
                    <video autoplay muted playsinline></video>
                </div>
            </div>
            
            <button onclick="testCameraStream()">Test Camera Stream</button>
            <button onclick="testScreenShare()">Test Screen Share</button>
            <button onclick="clearStream()">Clear Stream</button>
            
            <div class="status" id="streamStatus">
                Status: No stream
            </div>
        </div>
        
        <div class="test-section">
            <h2>Stream Format Test</h2>
            <p>Tests different stream formats (MediaStream, track-based, etc.)</p>
            
            <div id="formatTests">
                <!-- Test results will appear here -->
            </div>
        </div>
    </div>

    <script>
        // Test the stream handling functions
        function updateParticipantStream(participantId, stream, kind) {
            const statusEl = document.getElementById('streamStatus');
            const participantCard = document.getElementById('testParticipant');
            
            if (kind === 'video') {
                const videoContainer = participantCard.querySelector('.participant-video');
                const videoElement = videoContainer?.querySelector('video');
                const avatar = participantCard.querySelector('.avatar');

                if (stream) {
                    let mediaStream;
                    if (stream instanceof MediaStream) {
                        mediaStream = stream;
                    } else if (stream.track) {
                        mediaStream = new MediaStream([stream.track]);
                    } else if (stream.stream) {
                        mediaStream = stream.stream;
                    } else {
                        statusEl.textContent = `Status: Invalid stream format for ${participantId}`;
                        return;
                    }
                    
                    if (videoElement && mediaStream) {
                        videoElement.srcObject = mediaStream;
                        videoElement.play().catch(e => console.warn('Video play failed:', e));
                        
                        if (videoContainer) {
                            videoContainer.classList.remove('hidden');
                        }
                        if (avatar) {
                            avatar.style.zIndex = '5';
                        }
                        
                        statusEl.textContent = `Status: Video stream attached for ${participantId}`;
                    } else {
                        statusEl.textContent = `Status: Video element not found for ${participantId}`;
                    }
                } else {
                    if (videoElement) {
                        videoElement.srcObject = null;
                    }
                    if (videoContainer) {
                        videoContainer.classList.add('hidden');
                    }
                    if (avatar) {
                        avatar.style.zIndex = '10';
                    }
                    
                    statusEl.textContent = `Status: Video stream removed for ${participantId}`;
                }
            }
        }

        async function testCameraStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                
                // Test different stream formats
                const testFormats = [
                    { name: 'MediaStream', stream: stream },
                    { name: 'Track-based', stream: { track: stream.getVideoTracks()[0] } },
                    { name: 'Nested stream', stream: { stream: stream } }
                ];
                
                let currentFormat = 0;
                
                function nextFormat() {
                    if (currentFormat < testFormats.length) {
                        const format = testFormats[currentFormat];
                        console.log(`Testing format: ${format.name}`, format.stream);
                        updateParticipantStream('test-user', format.stream, 'video');
                        currentFormat++;
                        
                        if (currentFormat < testFormats.length) {
                            setTimeout(nextFormat, 3000);
                        }
                    }
                }
                
                nextFormat();
                
            } catch (error) {
                document.getElementById('streamStatus').textContent = `Status: Error - ${error.message}`;
            }
        }

        async function testScreenShare() {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                updateParticipantStream('test-user', stream, 'video');
            } catch (error) {
                document.getElementById('streamStatus').textContent = `Status: Screen share error - ${error.message}`;
            }
        }

        function clearStream() {
            updateParticipantStream('test-user', null, 'video');
        }

        // Test stream detection
        function testStreamDetection() {
            const results = document.getElementById('formatTests');
            results.innerHTML = '<h3>Stream Detection Results:</h3>';
            
            // Mock VideoSDK stream detection
            function detectStreamKind(stream, data) {
                if (stream instanceof MediaStream) {
                    const videoTracks = stream.getVideoTracks();
                    if (videoTracks.length > 0) {
                        const track = videoTracks[0];
                        const isScreenShare = track.label && (
                            track.label.toLowerCase().includes('screen') || 
                            track.label.toLowerCase().includes('display')
                        );
                        return isScreenShare ? 'share' : 'video';
                    } else {
                        return 'audio';
                    }
                } else if (stream.stream instanceof MediaStream) {
                    const videoTracks = stream.stream.getVideoTracks();
                    if (videoTracks.length > 0) {
                        const track = videoTracks[0];
                        const isScreenShare = track.label && (
                            track.label.toLowerCase().includes('screen') || 
                            track.label.toLowerCase().includes('display')
                        );
                        return isScreenShare ? 'share' : 'video';
                    } else {
                        return 'audio';
                    }
                } else if (stream.track?.kind === 'video') {
                    const isScreenShare = stream.track.label && (
                        stream.track.label.toLowerCase().includes('screen') || 
                        stream.track.label.toLowerCase().includes('display')
                    );
                    return isScreenShare ? 'share' : 'video';
                } else if (stream.track?.kind === 'audio') {
                    return 'audio';
                }
                return 'video';
            }
            
            // Test cases
            const testCases = [
                { name: 'Camera MediaStream', stream: { getTracks: () => [{ kind: 'video', label: 'camera' }] } },
                { name: 'Screen MediaStream', stream: { getTracks: () => [{ kind: 'video', label: 'screen capture' }] } },
                { name: 'Track-based camera', stream: { track: { kind: 'video', label: 'camera' } } },
                { name: 'Track-based screen', stream: { track: { kind: 'video', label: 'screen share' } } },
                { name: 'Nested camera', stream: { stream: { getVideoTracks: () => [{ label: 'camera' }] } } },
                { name: 'Nested screen', stream: { stream: { getVideoTracks: () => [{ label: 'display capture' }] } } },
            ];
            
            testCases.forEach(testCase => {
                try {
                    const result = detectStreamKind(testCase.stream, {});
                    const div = document.createElement('div');
                    div.innerHTML = `<strong>${testCase.name}:</strong> ${result}`;
                    results.appendChild(div);
                } catch (error) {
                    const div = document.createElement('div');
                    div.innerHTML = `<strong>${testCase.name}:</strong> ERROR - ${error.message}`;
                    div.style.color = '#ed4245';
                    results.appendChild(div);
                }
            });
        }
        
        // Run detection test on load
        testStreamDetection();
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>MisVord Fix Verification - Debug Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #2f3136; 
            color: white; 
            line-height: 1.6; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .section { 
            background: #36393f; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            display: flex; 
            align-items: center; 
        }
        .success { background: #4caf50; }
        .error { background: #f44336; }
        .warning { background: #ff9800; }
        .info { background: #2196f3; }
        .pending { background: #9e9e9e; }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold;
        }
        .btn-primary { background: #5865f2; color: white; }
        .btn-secondary { background: #36393f; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        #log { 
            background: #1e2124; 
            padding: 15px; 
            border-radius: 5px; 
            height: 300px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            white-space: pre-wrap;
        }
        .avatar-test {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .avatar-test img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .feature-list {
            list-style: none;
            padding: 0;
        }
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #4f545c;
        }
        .feature-list li:last-child {
            border-bottom: none;
        }
        .shortcut-info {
            background: #5865f2;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 MisVord Fix Verification Dashboard</h1>
            <p>Comprehensive testing for socket messaging, avatar fallback, and debug features</p>
        </div>

        <div class="shortcut-info">
            <strong>🎮 Debug Shortcuts:</strong> 
            Ctrl+1 (Test Message) | Ctrl+2 (Socket Status) | F12 (Console Logs)
        </div>

        <div class="grid">
            <div class="section">
                <h3>🔌 Socket Connection Test</h3>
                <div id="socket-status" class="status pending">
                    🔄 Pending connection test...
                </div>
                <button class="btn-primary" onclick="testSocketConnection()">Test Socket</button>
                <button class="btn-secondary" onclick="testAuthentication()">Test Auth</button>
                <button class="btn-success" onclick="testChannelJoin()">Test Channel Join</button>
                <button class="btn-danger" onclick="disconnectSocket()">Disconnect</button>
            </div>

            <div class="section">
                <h3>🖼️ Avatar Fallback Test</h3>
                <div class="avatar-test">
                    <img src="/assets/default-avatar.svg" alt="SVG Avatar" onerror="this.style.border='2px solid red';">
                    <span>SVG Default Avatar (should load)</span>
                </div>
                <div class="avatar-test">
                    <img src="/assets/nonexistent-avatar.png" alt="Broken Avatar" onerror="avatarErrorHandler(this)">
                    <span>Broken Avatar URL (should fallback)</span>
                </div>
                <div class="avatar-test">
                    <img src="https://httpstat.us/404" alt="404 Avatar" onerror="avatarErrorHandler(this)">
                    <span>Network 404 Avatar (should fallback)</span>
                </div>
                <div id="avatar-status" class="status info">
                    ℹ️ Testing avatar fallback mechanisms...
                </div>
            </div>
        </div>

        <div class="section">
            <h3>✅ Fixed Features Status</h3>
            <ul class="feature-list">
                <li id="feature-socket-debug">🔍 <strong>Socket Debug Logging:</strong> <span class="pending">Testing...</span></li>
                <li id="feature-avatar-fallback">🖼️ <strong>Avatar Fallback:</strong> <span class="pending">Testing...</span></li>
                <li id="feature-ctrl2-status">⌨️ <strong>Ctrl+2 Socket Status:</strong> <span class="pending">Testing...</span></li>
                <li id="feature-real-time-messaging">💬 <strong>Real-time Messaging:</strong> <span class="pending">Testing...</span></li>
                <li id="feature-server-health">🏥 <strong>Server Health:</strong> <span class="pending">Checking...</span></li>
            </ul>
        </div>

        <div class="section">
            <h3>📊 Debug Log</h3>
            <button class="btn-secondary" onclick="clearLog()">Clear Log</button>
            <button class="btn-secondary" onclick="exportLog()">Export Log</button>
            <div id="log"></div>
        </div>
    </div>

    <script>
        let socket = null;
        let testResults = {
            socketConnection: false,
            authentication: false,
            avatarFallback: false,
            debugLogging: false,
            realTimeMessaging: false
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const typeEmoji = {
                'info': 'ℹ️',
                'success': '✅',
                'error': '❌',
                'warning': '⚠️',
                'debug': '🔍'
            };
            
            const logMessage = `[${timestamp}] ${typeEmoji[type] || '📝'} ${message}`;
            logDiv.textContent += logMessage + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logMessage);
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status ${type}`;
                element.innerHTML = message;
            }
        }

        function updateFeatureStatus(featureId, status) {
            const element = document.getElementById(featureId);
            if (element) {
                const span = element.querySelector('span');
                if (span) {
                    span.className = status ? 'success' : 'error';
                    span.textContent = status ? '✅ Working' : '❌ Failed';
                }
            }
        }

        function testSocketConnection() {
            log('🔌 Starting comprehensive socket connection test...', 'info');
            
            if (socket) {
                socket.disconnect();
            }

            const socketUrl = 'http://localhost:1002';
            log(`📡 Connecting to: ${socketUrl}`, 'info');

            socket = io(socketUrl, {
                forceNew: true,
                timeout: 10000,
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                log(`✅ Socket connected! ID: ${socket.id}`, 'success');
                updateStatus('socket-status', `✅ Connected to socket server (ID: ${socket.id})`, 'success');
                testResults.socketConnection = true;
                updateFeatureStatus('feature-socket-debug', true);
            });

            socket.on('connect_error', (error) => {
                log(`❌ Connection failed: ${error.message}`, 'error');
                updateStatus('socket-status', `❌ Connection failed: ${error.message}`, 'error');
                testResults.socketConnection = false;
                updateFeatureStatus('feature-socket-debug', false);
            });

            socket.on('disconnect', (reason) => {
                log(`🔌 Disconnected: ${reason}`, 'warning');
                updateStatus('socket-status', `🔌 Disconnected: ${reason}`, 'warning');
            });

            socket.on('authenticated', (data) => {
                log(`🔐 Authentication successful: ${JSON.stringify(data)}`, 'success');
                testResults.authentication = true;
                updateFeatureStatus('feature-real-time-messaging', true);
            });

            socket.on('authentication_error', (error) => {
                log(`🔐 Authentication failed: ${JSON.stringify(error)}`, 'error');
                testResults.authentication = false;
            });
        }

        function testAuthentication() {
            if (!socket || !socket.connected) {
                log('❌ Socket not connected. Connect first.', 'error');
                return;
            }

            log('🔐 Testing authentication with mock user data...', 'info');
            
            const authData = {
                user_id: 1,
                username: 'test_user',
                token: 'debug_token_' + Date.now()
            };

            log(`📤 Sending auth data: ${JSON.stringify(authData)}`, 'debug');
            socket.emit('authenticate', authData);
        }

        function testChannelJoin() {
            if (!socket || !socket.connected) {
                log('❌ Socket not connected. Connect first.', 'error');
                return;
            }

            log('📺 Testing channel join...', 'info');
            socket.emit('join-channel', { channel_id: 1, server_id: 1 });
        }

        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                log('🔌 Socket disconnected manually', 'warning');
            }
        }

        function avatarErrorHandler(img) {
            log(`🖼️ Avatar failed to load: ${img.src}`, 'warning');
            
            // Apply the same fallback as in the main app
            const fallbackSvg = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxjaXJjbGUgY3g9IjIwIiBjeT0iMjAiIHI9IjIwIiBmaWxsPSIjNTg2NUYyIi8+CiAgICA8Y2lyY2xlIGN4PSIyMCIgY3k9IjE1IiByPSI2IiBmaWxsPSJ3aGl0ZSIvPgogICAgPHBhdGggZD0iTTggMzJDOCAyNi41IDEyLjUgMjIgMTggMjJIMjJDMjcuNSAyMiAzMiAyNi41IDMyIDMyVjM1QzMyIDM2LjEgMzEuMSAzNyAzMCAzN0gxMEM4LjkgMzcgOCAzNi4xIDggMzVWMzJaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K';
            
            img.src = fallbackSvg;
            img.style.border = '2px solid #4caf50';
            log('🖼️ Avatar fallback applied successfully', 'success');
            
            testResults.avatarFallback = true;
            updateFeatureStatus('feature-avatar-fallback', true);
            updateStatus('avatar-status', '✅ Avatar fallback working correctly', 'success');
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        function exportLog() {
            const logContent = document.getElementById('log').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `misvord-debug-log-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function checkServerHealth() {
            log('🏥 Checking server health...', 'info');
            
            fetch('http://localhost:1002/health')
                .then(response => response.json())
                .then(data => {
                    log(`🏥 Server health: ${JSON.stringify(data)}`, 'success');
                    updateFeatureStatus('feature-server-health', true);
                })
                .catch(error => {
                    log(`🏥 Server health check failed: ${error.message}`, 'error');
                    updateFeatureStatus('feature-server-health', false);
                });
        }

        // Keyboard shortcuts test
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === '2') {
                e.preventDefault();
                log('⌨️ Ctrl+2 shortcut triggered - this would show socket status in main app', 'success');
                updateFeatureStatus('feature-ctrl2-status', true);
            }
        });

        // Initialize tests
        window.addEventListener('load', () => {
            log('🚀 Fix verification dashboard loaded', 'info');
            log('📋 Socket.IO version: ' + (typeof io !== 'undefined' ? 'Loaded' : 'Not loaded'), 'info');
            log('🎮 Press Ctrl+2 to test keyboard shortcut', 'info');
            
            // Auto-check server health
            checkServerHealth();
            
            // Test avatar fallback after a short delay
            setTimeout(() => {
                log('🖼️ Testing avatar fallback automatically...', 'info');
            }, 1000);
        });
    </script>
</body>
</html>

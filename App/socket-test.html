<!DOCTYPE html>
<html>
<head>
    <title>Socket Status Test - MisVord</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #2f3136; color: white; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #4caf50; }
        .error { background: #f44336; }
        .warning { background: #ff9800; }
        .info { background: #2196f3; }
        button { padding: 10px 20px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #5865f2; color: white; }
        .btn-secondary { background: #36393f; color: white; }
        #log { background: #1e2124; padding: 10px; border-radius: 5px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîç Socket Status Test - MisVord</h1>
    <div id="status"></div>
      <div>        <button class="btn-primary" onclick="testConnection()">Test Socket Connection</button>
        <button class="btn-secondary" onclick="testAuthentication()">Test Authentication</button>
        <button class="btn-secondary" onclick="testMisVordMessaging()">Test MisVord Messaging</button>
        <button class="btn-secondary" onclick="joinTestRoom()">Join Test DM Room</button>
        <button class="btn-secondary" onclick="sendTestMessage()">Send Test Message</button>
        <button class="btn-secondary" onclick="debugRooms()">Debug Rooms</button>
        <button class="btn-secondary" onclick="clearLog()">Clear Log</button>
    </div>
    
    <div style="margin: 20px 0;">
        <h3>Quick Message Test:</h3>
        <input type="text" id="roomId" placeholder="Enter room ID (e.g., 1)" style="padding: 8px; margin: 5px; background: #40444b; color: white; border: 1px solid #666; border-radius: 3px;">
        <input type="text" id="testMessage" placeholder="Enter test message" style="padding: 8px; margin: 5px; background: #40444b; color: white; border: 1px solid #666; border-radius: 3px; width: 200px;">
        <button class="btn-primary" onclick="quickMessageTest()">Quick Test</button>
    </div>
    
    <h3>Debug Log:</h3>
    <div id="log"></div>
    
    <script>
        let socket = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function testConnection() {
            log('üîå Starting socket connection test...');
            
            if (socket) {
                socket.disconnect();
            }
            
            const socketUrl = 'http://localhost:1002';
            log(`üì° Attempting to connect to: ${socketUrl}`);
            
            socket = io(socketUrl, {
                forceNew: true,
                timeout: 5000,
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', () => {
                log('‚úÖ Socket connected successfully!');
                log(`üÜî Socket ID: ${socket.id}`);
                updateStatus(`‚úÖ Connected to socket server (ID: ${socket.id})`, 'success');
            });
            
            socket.on('connect_error', (error) => {
                log(`‚ùå Connection failed: ${error.message}`);
                updateStatus(`‚ùå Connection failed: ${error.message}`, 'error');
            });
            
            socket.on('disconnect', (reason) => {
                log(`üîå Disconnected: ${reason}`);
                updateStatus(`üîå Disconnected: ${reason}`, 'warning');
            });
            
            socket.on('authenticated', (data) => {
                log(`‚úÖ Authentication successful: ${JSON.stringify(data)}`);
                updateStatus('‚úÖ Authenticated successfully', 'success');
            });
              socket.on('authentication_error', (error) => {
                log(`‚ùå Authentication failed: ${JSON.stringify(error)}`);
                updateStatus(`‚ùå Authentication failed: ${error.message || 'Unknown error'}`, 'error');
            });
            
            // Room events
            socket.on('dm-room-joined', (data) => {
                log('‚úÖ DM room joined: ' + JSON.stringify(data));
            });
            
            socket.on('dm-room-join-failed', (data) => {
                log('‚ùå DM room join failed: ' + JSON.stringify(data));
            });
            
            socket.on('user-joined-dm-room', (data) => {
                log('üë§ User joined DM room: ' + JSON.stringify(data));
            });
            
            socket.on('room-joined', (data) => {
                log('‚úÖ Room joined: ' + JSON.stringify(data));
            });
            
            // Message events
            socket.on('new-direct-message', (data) => {
                log('üì® NEW DIRECT MESSAGE RECEIVED: ' + JSON.stringify(data, null, 2));
            });
            
            socket.on('message-sent-confirmation', (data) => {
                log('‚úÖ Message sent confirmation: ' + JSON.stringify(data));
            });
            
            socket.on('message_error', (data) => {
                log('‚ùå Message error: ' + JSON.stringify(data));
            });
            
            // Debug events
            socket.on('debug-response', (data) => {
                log('üîç Debug response: ' + JSON.stringify(data, null, 2));
            });
        }
        
        function testAuthentication() {
            if (!socket || !socket.connected) {
                log('‚ùå Socket not connected. Connect first.');
                updateStatus('‚ùå Socket not connected. Connect first.', 'error');
                return;
            }
            
            log('üîê Testing authentication...');
            
            // Simulate authentication with test credentials
            const authData = {
                user_id: 1,
                username: 'test_user',
                token: 'test_token_123'
            };
            
            log(`üì§ Sending authentication data: ${JSON.stringify(authData)}`);
            socket.emit('authenticate', authData);
            
            // Set timeout for authentication
            setTimeout(() => {
                if (socket.connected) {
                    log('‚è±Ô∏è Authentication timeout - no response received');
                    updateStatus('‚è±Ô∏è Authentication timeout', 'warning');
                }
            }, 5000);
        }
        
        function testMisVordMessaging() {
            log('üîß Testing MisVordMessaging system...');
            
            if (!window.MisVordMessaging) {
                log('‚ùå MisVordMessaging not available');
                updateStatus('‚ùå MisVordMessaging not available', 'error');
                return;
            }
            
            log('üìä MisVordMessaging status:');
            log(`  - Available: ${!!window.MisVordMessaging}`);
            log(`  - Initialized: ${window.MisVordMessaging.initialized}`);
            log(`  - Connected: ${window.MisVordMessaging.connected}`);
            log(`  - Socket Manager: ${!!window.MisVordMessaging.socketManager}`);
            
            if (!window.MisVordMessaging.initialized) {
                log('üîÑ Attempting to initialize MisVordMessaging...');
                try {
                    window.MisVordMessaging.init();
                    log('‚úÖ MisVordMessaging initialization successful');
                    updateStatus('‚úÖ MisVordMessaging initialized', 'success');
                } catch (error) {
                    log(`‚ùå MisVordMessaging initialization failed: ${error.message}`);
                    updateStatus(`‚ùå MisVordMessaging initialization failed: ${error.message}`, 'error');
                }
            } else {
                log('‚úÖ MisVordMessaging already initialized');
                updateStatus('‚úÖ MisVordMessaging already initialized', 'success');
            }
        }
          function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function joinTestRoom() {
            const roomId = document.getElementById('roomId').value || '1';
            log(`üè† Attempting to join DM room: ${roomId}`);
            
            if (socket && socket.connected) {
                socket.emit('join-dm-room', { roomId: roomId });
                log(`üì° Emitted join-dm-room event for room ${roomId}`);
            } else {
                log('‚ùå Socket not connected');
            }
        }
        
        function sendTestMessage() {
            const roomId = document.getElementById('roomId').value || '1';
            const message = document.getElementById('testMessage').value || `Test message ${new Date().toLocaleTimeString()}`;
            
            log(`üì§ Attempting to send message to room ${roomId}: ${message}`);
            
            if (socket && socket.connected) {
                const messageData = {
                    roomId: roomId,
                    content: message,
                    messageType: 'text',
                    timestamp: Date.now()
                };
                
                socket.emit('direct-message', messageData);
                log(`üì° Emitted direct-message event:`, JSON.stringify(messageData, null, 2));
            } else {
                log('‚ùå Socket not connected');
            }
        }
        
        function debugRooms() {
            log('üîç Requesting room debug information...');
            
            if (socket && socket.connected) {
                socket.emit('debug-rooms');
                log('üì° Emitted debug-rooms event');
            } else {
                log('‚ùå Socket not connected');
            }
        }
        
        function quickMessageTest() {
            const roomId = document.getElementById('roomId').value || '1';
            const message = document.getElementById('testMessage').value || `Quick test ${new Date().toLocaleTimeString()}`;
            
            log(`üöÄ Quick test: joining room ${roomId} and sending message`);
            
            // First join the room
            if (socket && socket.connected) {
                socket.emit('join-dm-room', { roomId: roomId });
                log(`üì° Step 1: Joined room ${roomId}`);
                
                // Wait a bit then send message
                setTimeout(() => {
                    const messageData = {
                        roomId: roomId,
                        content: message,
                        messageType: 'text',
                        timestamp: Date.now()
                    };
                    
                    socket.emit('direct-message', messageData);
                    log(`üì° Step 2: Sent message: ${message}`);
                }, 1000);
            } else {
                log('‚ùå Socket not connected');
            }
        }
        
        // Auto-start connection test
        log('üöÄ Socket status test page loaded');
        log('üìã Socket.IO version: ' + (typeof io !== 'undefined' ? io.version : 'Not loaded'));
        updateStatus('Ready to test socket connection', 'info');
    </script>
</body>
</html>

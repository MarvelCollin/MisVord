<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 4px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        button:hover {
            background-color: #0069d9;
        }
        button.disconnect {
            background-color: #dc3545;
        }
        button.disconnect:hover {
            background-color: #c82333;
        }
        .settings {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .log {
            height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 20px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .input-group {
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Socket.IO Connection Test</h1>
        
        <div class="settings">
            <h2>Connection Settings</h2>
            <div class="input-group">
                <label for="serverUrl">Server URL:</label>
                <input type="text" id="serverUrl" value="http://localhost:1002">
            </div>
            <div class="input-group">
                <label for="socketPath">Socket.IO Path:</label>
                <input type="text" id="socketPath" value="/misvord/socket/socket.io">
            </div>
            <div>
                <button id="useStandardPath">Use Standard Path (/socket.io)</button>
                <button id="useStandardizedPath">Use Standardized Path (/misvord/socket/socket.io)</button>
                <button id="useDockerSettings">Use Docker Settings</button>
                <button id="useEnvSettings">Load from ENV</button>
            </div>
        </div>
        
        <div id="connectionStatus" class="status disconnected">
            Disconnected
        </div>
        
        <div>
            <button id="connect">Connect</button>
            <button id="disconnect" class="disconnect">Disconnect</button>
            <button id="sendPing">Send Ping</button>
            <button id="clearLog">Clear Log</button>
        </div>
        
        <div class="log" id="log">Connection log will appear here...</div>
    </div>
    
    <script src="js/socket.io.min.js"></script>
    <script>
        // ENV Configuration - This simulates reading from .env file
        // In a real app, these would be loaded from the server
        if (typeof window.ENV_CONFIG === 'undefined') {
            window.ENV_CONFIG = {
                SOCKET_SERVER: 'https://marvelcollin.my.id',
                SOCKET_SERVER_LOCAL: 'http://localhost:1002',
                SOCKET_PATH: '/misvord/socket/socket.io',
                SOCKET_PATH_LOCAL: '/socket.io',
                IS_VPS: true
            };
        }
        
        let socket;
        
        // DOM elements
        const connectBtn = document.getElementById('connect');
        const disconnectBtn = document.getElementById('disconnect');
        const sendPingBtn = document.getElementById('sendPing');
        const clearLogBtn = document.getElementById('clearLog');
        const useStandardPathBtn = document.getElementById('useStandardPath');
        const useStandardizedPathBtn = document.getElementById('useStandardizedPath');
        const useDockerSettingsBtn = document.getElementById('useDockerSettings');
        const useEnvSettingsBtn = document.getElementById('useEnvSettings');
        const connectionStatus = document.getElementById('connectionStatus');
        const logElement = document.getElementById('log');
        const serverUrlInput = document.getElementById('serverUrl');
        const socketPathInput = document.getElementById('socketPath');
        
        // Helper to log messages
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().substr(11, 8);
            const line = `[${timestamp}] [${type}] ${message}`;
            logElement.innerHTML += line + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            console.log(line);
        }
        
        // Clear the log
        clearLogBtn.addEventListener('click', () => {
            logElement.innerHTML = '';
        });
        
        // Set connection status
        function setStatus(state) {
            connectionStatus.className = 'status ' + state;
            switch(state) {
                case 'connected':
                    connectionStatus.textContent = 'Connected! Socket ID: ' + (socket ? socket.id : 'unknown');
                    break;
                case 'connecting':
                    connectionStatus.textContent = 'Connecting...';
                    break;
                case 'disconnected':
                    connectionStatus.textContent = 'Disconnected';
                    break;
                default:
                    connectionStatus.textContent = state;
            }
        }
        
        // Load settings from ENV
        useEnvSettingsBtn.addEventListener('click', () => {
            const isLocal = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1';
            
            // Choose the appropriate socket server URL based on environment
            serverUrlInput.value = isLocal ? window.ENV_CONFIG.SOCKET_SERVER_LOCAL : window.ENV_CONFIG.SOCKET_SERVER;
            socketPathInput.value = isLocal ? window.ENV_CONFIG.SOCKET_PATH_LOCAL : window.ENV_CONFIG.SOCKET_PATH;
            
            log(`Loaded settings from ENV: ${serverUrlInput.value}, path: ${socketPathInput.value}`, 'info');
        });
        
        // Connect to socket.io server
        connectBtn.addEventListener('click', () => {
            const serverUrl = serverUrlInput.value.trim();
            const socketPath = socketPathInput.value.trim();
            
            if (!serverUrl) {
                log('Server URL is required', 'error');
                return;
            }
            
            try {
                // Disconnect any existing socket
                if (socket && socket.connected) {
                    socket.disconnect();
                }
                
                setStatus('connecting');
                log(`Connecting to ${serverUrl} with path ${socketPath}`);
                
                // Create new socket connection
                socket = io(serverUrl, {
                    path: socketPath,
                    transports: ['websocket', 'polling'],
                    reconnectionAttempts: 3,
                    timeout: 10000
                });
                
                // Socket events
                socket.on('connect', () => {
                    setStatus('connected');
                    log(`Connected successfully! Socket ID: ${socket.id}`, 'success');
                    log(`Transport: ${socket.io.engine.transport.name}`);
                    
                    // Join test room
                    socket.emit('join-video-room', { 
                        roomId: 'test-room',
                        userName: 'WebSocketTester_' + Math.floor(Math.random() * 1000)
                    });
                    log('Joined test room');
                });
                
                socket.on('connect_error', (error) => {
                    log(`Connection error: ${error.message}`, 'error');
                    setStatus('disconnected');
                });
                
                socket.on('disconnect', (reason) => {
                    log(`Disconnected: ${reason}`);
                    setStatus('disconnected');
                });
                
                socket.on('room-joined', (data) => {
                    log(`Room joined: ${JSON.stringify(data)}`, 'success');
                });
                
                socket.on('pong', (data) => {
                    log(`Received pong: ${JSON.stringify(data)}`);
                });
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                setStatus('disconnected');
            }
        });
        
        // Disconnect button
        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.disconnect();
                log('Manually disconnected');
                setStatus('disconnected');
            }
        });
        
        // Send ping
        sendPingBtn.addEventListener('click', () => {
            if (socket && socket.connected) {
                socket.emit('ping', { timestamp: Date.now() });
                log('Ping sent');
            } else {
                log('Cannot send ping: not connected', 'error');
            }
        });
        
        // Use standard path
        useStandardPathBtn.addEventListener('click', () => {
            socketPathInput.value = '/socket.io';
            log('Set path to standard Socket.IO path: /socket.io');
        });
        
        // Use standardized path
        useStandardizedPathBtn.addEventListener('click', () => {
            socketPathInput.value = '/misvord/socket/socket.io';
            log('Set path to standardized path: /misvord/socket/socket.io');
        });
        
        // Use Docker settings
        useDockerSettingsBtn.addEventListener('click', () => {
            serverUrlInput.value = 'http://localhost:1002';
            socketPathInput.value = '/misvord/socket/socket.io';
            log('Set Docker-compatible settings');
        });
        
        // Initial log
        log('Socket.IO Test Page loaded. Click "Connect" to start.');
    </script>
</body>
</html> 
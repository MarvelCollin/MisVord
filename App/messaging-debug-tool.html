<!DOCTYPE html>
<html>
<head>
    <title>MisVord Messaging Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #2f3136; color: white; }
        .tool { background: #36393f; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #4caf50; }
        .error { background: #f44336; }
        .warning { background: #ff9800; }
        .info { background: #2196f3; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #5865f2; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        #output { background: #1e2124; padding: 15px; border-radius: 5px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .code-block { background: #1e2124; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>🔧 MisVord Messaging Debug Tool</h1>
    
    <div class="tool">
        <h3>📋 Copy and paste this into the browser console on the MisVord app page:</h3>
        <div class="code-block">
            <pre id="debug-script">// MisVord Messaging Debug Script
console.log('🔧 Starting MisVord Messaging Debug...');

// Check current state
console.log('📊 Current State:');
console.log('  - MisVordMessaging available:', !!window.MisVordMessaging);
console.log('  - Global Socket Manager available:', !!window.globalSocketManager);
console.log('  - Socket.IO available:', typeof io !== 'undefined');

if (window.MisVordMessaging) {
    console.log('  - MisVordMessaging initialized:', window.MisVordMessaging.initialized);
    console.log('  - MisVordMessaging connected:', window.MisVordMessaging.connected);
    console.log('  - Socket Manager available:', !!window.MisVordMessaging.socketManager);
}

if (window.globalSocketManager) {
    console.log('  - Global Socket Manager ready:', window.globalSocketManager.isReady());
    console.log('  - Global Socket Manager connected:', window.globalSocketManager.connected);
    console.log('  - Global Socket Manager authenticated:', window.globalSocketManager.authenticated);
}

// Fix MisVordMessaging if needed
if (window.MisVordMessaging && !window.MisVordMessaging.initialized) {
    console.log('🔄 Attempting to initialize MisVordMessaging...');
    try {
        window.MisVordMessaging.init();
        console.log('✅ MisVordMessaging initialization completed');
    } catch (error) {
        console.error('❌ MisVordMessaging initialization failed:', error);
    }
}

// Force connection to global socket manager
if (window.MisVordMessaging && window.globalSocketManager && window.globalSocketManager.isReady()) {
    console.log('🔄 Forcing connection to global socket manager...');
    try {
        if (window.MisVordMessaging.socketManager && window.MisVordMessaging.socketManager.connectToGlobalSocketManager) {
            window.MisVordMessaging.socketManager.connectToGlobalSocketManager();
            console.log('✅ Connection attempt completed');
        }
    } catch (error) {
        console.error('❌ Connection attempt failed:', error);
    }
}

// Set up DM context if on DM page
const urlParams = new URLSearchParams(window.location.search);
const dmParam = urlParams.get('dm');
if (dmParam && window.MisVordMessaging) {
    console.log('🔄 Setting up DM context for:', dmParam);
    window.MisVordMessaging.activeChatRoom = dmParam;
    window.MisVordMessaging.chatType = 'direct';
    
    if (window.MisVordMessaging.joinDMRoom) {
        try {
            window.MisVordMessaging.joinDMRoom(dmParam);
            console.log('✅ DM room joined');
        } catch (error) {
            console.error('❌ Failed to join DM room:', error);
        }
    }
}

// Final status check
setTimeout(() => {
    console.log('📊 Final Status:');
    if (window.MisVordMessaging) {
        console.log('  - MisVordMessaging initialized:', window.MisVordMessaging.initialized);
        console.log('  - MisVordMessaging connected:', window.MisVordMessaging.connected);
        console.log('  - Socket Manager connected:', window.MisVordMessaging.socketManager?.connected);
        console.log('  - Socket Manager authenticated:', window.MisVordMessaging.socketManager?.authenticated);
    }
    
    console.log('🎉 Debug script completed!');
    console.log('💡 Try using Ctrl+2 to check socket status or Ctrl+3 to force messaging init');
}, 1000);</pre>
        </div>
        
        <button class="btn-primary" onclick="copyDebugScript()">📋 Copy Debug Script</button>
        <button class="btn-success" onclick="openMisVordApp()">🚀 Open MisVord App</button>
    </div>
    
    <div class="tool">
        <h3>🎮 Manual Testing Steps:</h3>
        <ol>
            <li>Open MisVord app at <code>http://localhost:1001/app?dm=1</code></li>
            <li>Press <strong>F12</strong> to open Developer Tools</li>
            <li>Paste the debug script above into the Console tab</li>
            <li>Press <strong>Enter</strong> to run the script</li>
            <li>Use <strong>Ctrl+2</strong> to check socket status</li>
            <li>Use <strong>Ctrl+3</strong> to force messaging initialization</li>
            <li>Try sending a test message</li>
        </ol>
    </div>
    
    <div class="tool">
        <h3>🔍 Expected Results:</h3>
        <div class="status success">✅ Socket.IO Available: true</div>
        <div class="status success">✅ Global Socket Ready: true</div>
        <div class="status success">✅ Socket Connected: true</div>
        <div class="status success">✅ User Authenticated: true</div>
        <div class="status success">✅ Messaging Ready: true</div>
        <div class="status success">✅ Overall Status: 'fully-connected'</div>
    </div>
    
    <script>
        function copyDebugScript() {
            const script = document.getElementById('debug-script').textContent;
            navigator.clipboard.writeText(script).then(() => {
                alert('Debug script copied to clipboard! Paste it in the browser console.');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy. Please manually copy the script above.');
            });
        }
        
        function openMisVordApp() {
            window.open('http://localhost:1001/app?dm=1', '_blank');
        }
    </script>
</body>
</html>

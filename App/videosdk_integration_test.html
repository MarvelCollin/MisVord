<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoSDK Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: white;
            margin: 0;
            padding: 20px;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-section {
            background: #2d2d2d;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .success { background: #4CAF50; }
        .error { background: #F44336; }
        .info { background: #2196F3; }
        .warning { background: #FF9800; }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        .video-item {
            flex: 1;
            min-width: 300px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        
        video {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .participant-info {
            padding: 10px;
            background: #333;
            text-align: center;
        }
        
        #log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🚀 VideoSDK Integration Test</h1>
        
        <div class="test-section">
            <h2>1. Configuration Status</h2>
            <div id="config-status">Testing configuration...</div>
        </div>
        
        <div class="test-section">
            <h2>2. VideoSDK Library Status</h2>
            <div id="library-status">Loading VideoSDK...</div>
        </div>
        
        <div class="test-section">
            <h2>3. Meeting Controls</h2>
            <button id="create-meeting" disabled>Create Meeting</button>
            <button id="join-meeting" disabled>Join Meeting</button>
            <button id="leave-meeting" disabled>Leave Meeting</button>
            <div id="meeting-info"></div>
        </div>
        
        <div class="test-section">
            <h2>4. Media Controls</h2>
            <button id="toggle-mic" disabled>Toggle Microphone</button>
            <button id="toggle-camera" disabled>Toggle Camera</button>
            <button id="toggle-screen" disabled>Share Screen</button>
            <div id="media-status"></div>
        </div>
        
        <div class="test-section">
            <h2>5. Participants & Video</h2>
            <div id="video-container"></div>
            <div id="participants-list"></div>
        </div>
        
        <div class="test-section">
            <h2>6. Debug Log</h2>
            <div id="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <!-- VideoSDK Library -->
    <script src="https://sdk.videosdk.live/js-sdk/0.1.6/videosdk.js"></script>
    
    <script>
        // Configuration from backend
        const API_KEY = '8ad2dbcd-638d-4fbb-999c-9a48a83caa15';
        let authToken = null;
        let meeting = null;
        let participants = new Map();
        
        // Status elements
        const configStatus = document.getElementById('config-status');
        const libraryStatus = document.getElementById('library-status');
        const meetingInfo = document.getElementById('meeting-info');
        const mediaStatus = document.getElementById('media-status');
        const participantsList = document.getElementById('participants-list');
        const videoContainer = document.getElementById('video-container');
        const logElement = document.getElementById('log');
        
        // Control buttons
        const createMeetingBtn = document.getElementById('create-meeting');
        const joinMeetingBtn = document.getElementById('join-meeting');
        const leaveMeetingBtn = document.getElementById('leave-meeting');
        const toggleMicBtn = document.getElementById('toggle-mic');
        const toggleCameraBtn = document.getElementById('toggle-camera');
        const toggleScreenBtn = document.getElementById('toggle-screen');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logElement.innerHTML += logEntry + '\\n';
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function clearLog() {
            logElement.innerHTML = '';
        }
        
        function updateStatus(element, message, type) {
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        async function initializeVideoSDK() {
            try {
                // Step 1: Get authentication token
                log('🔐 Getting authentication token...');
                const response = await fetch('/videosdk_api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'get_token'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.token) {
                    authToken = data.token;
                    log('✅ Authentication token received');
                    updateStatus(configStatus, '✅ Configuration loaded successfully', 'success');
                    
                    // Step 2: Initialize VideoSDK
                    if (typeof VideoSDK !== 'undefined') {
                        log('🚀 Initializing VideoSDK...');
                        VideoSDK.config(authToken);
                        updateStatus(libraryStatus, '✅ VideoSDK library loaded and configured', 'success');
                        
                        // Enable controls
                        createMeetingBtn.disabled = false;
                        log('✅ VideoSDK initialization complete');
                        
                    } else {
                        throw new Error('VideoSDK library not loaded');
                    }
                } else {
                    throw new Error('Failed to get authentication token: ' + (data.message || 'Unknown error'));
                }
                
            } catch (error) {
                log('❌ Initialization error: ' + error.message);
                updateStatus(configStatus, '❌ Configuration failed: ' + error.message, 'error');
                updateStatus(libraryStatus, '❌ VideoSDK initialization failed', 'error');
            }
        }
        
        async function createMeeting() {
            try {
                log('🏗️ Creating new meeting...');
                
                const response = await fetch('/videosdk_api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'create_meeting'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.meetingId) {
                    log('✅ Meeting created: ' + data.meetingId);
                    updateStatus(meetingInfo, `✅ Meeting created: ${data.meetingId}`, 'success');
                    
                    // Auto-join the created meeting
                    await joinMeeting(data.meetingId);
                    
                } else {
                    throw new Error('Failed to create meeting: ' + (data.message || 'Unknown error'));
                }
                
            } catch (error) {
                log('❌ Create meeting error: ' + error.message);
                updateStatus(meetingInfo, '❌ Failed to create meeting: ' + error.message, 'error');
            }
        }
        
        async function joinMeeting(meetingId = null) {
            try {
                if (!meetingId) {
                    meetingId = prompt('Enter Meeting ID to join:');
                    if (!meetingId) return;
                }
                
                log('🔗 Joining meeting: ' + meetingId);
                
                meeting = VideoSDK.initMeeting({
                    meetingId: meetingId,
                    name: 'Test Participant ' + Math.floor(Math.random() * 1000),
                    micEnabled: true,
                    webcamEnabled: true,
                });
                
                // Event listeners
                meeting.on('meeting-joined', () => {
                    log('✅ Successfully joined meeting');
                    updateStatus(meetingInfo, `✅ Joined meeting: ${meetingId}`, 'success');
                    
                    // Enable controls
                    leaveMeetingBtn.disabled = false;
                    toggleMicBtn.disabled = false;
                    toggleCameraBtn.disabled = false;
                    toggleScreenBtn.disabled = false;
                    createMeetingBtn.disabled = true;
                    joinMeetingBtn.disabled = true;
                    
                    updateMediaStatus();
                });
                
                meeting.on('meeting-left', () => {
                    log('👋 Left meeting');
                    updateStatus(meetingInfo, '👋 Left meeting', 'info');
                    
                    // Reset controls
                    leaveMeetingBtn.disabled = true;
                    toggleMicBtn.disabled = true;
                    toggleCameraBtn.disabled = true;
                    toggleScreenBtn.disabled = true;
                    createMeetingBtn.disabled = false;
                    joinMeetingBtn.disabled = false;
                    
                    // Clear participants
                    participants.clear();
                    videoContainer.innerHTML = '';
                    participantsList.innerHTML = '';
                });
                
                meeting.on('participant-joined', (participant) => {
                    log('👤 Participant joined: ' + participant.displayName);
                    participants.set(participant.id, participant);
                    updateParticipantsList();
                    setupParticipantVideo(participant);
                });
                
                meeting.on('participant-left', (participant) => {
                    log('👤 Participant left: ' + participant.displayName);
                    participants.delete(participant.id);
                    updateParticipantsList();
                    removeParticipantVideo(participant.id);
                });
                
                // Join the meeting
                meeting.join();
                
            } catch (error) {
                log('❌ Join meeting error: ' + error.message);
                updateStatus(meetingInfo, '❌ Failed to join meeting: ' + error.message, 'error');
            }
        }
        
        function leaveMeeting() {
            if (meeting) {
                log('👋 Leaving meeting...');
                meeting.leave();
                meeting = null;
            }
        }
        
        function toggleMicrophone() {
            if (meeting) {
                if (meeting.localMicOn) {
                    meeting.muteMic();
                    log('🔇 Microphone muted');
                } else {
                    meeting.unmuteMic();
                    log('🎤 Microphone unmuted');
                }
                updateMediaStatus();
            }
        }
        
        function toggleCamera() {
            if (meeting) {
                if (meeting.localWebcamOn) {
                    meeting.disableWebcam();
                    log('📹 Camera disabled');
                } else {
                    meeting.enableWebcam();
                    log('📹 Camera enabled');
                }
                updateMediaStatus();
            }
        }
        
        function toggleScreenShare() {
            if (meeting) {
                if (meeting.localScreenShareOn) {
                    meeting.disableScreenShare();
                    log('🖥️ Screen sharing stopped');
                } else {
                    meeting.enableScreenShare();
                    log('🖥️ Screen sharing started');
                }
                updateMediaStatus();
            }
        }
        
        function updateMediaStatus() {
            if (meeting) {
                const micStatus = meeting.localMicOn ? '🎤 On' : '🔇 Off';
                const cameraStatus = meeting.localWebcamOn ? '📹 On' : '📹 Off';
                const screenStatus = meeting.localScreenShareOn ? '🖥️ Sharing' : '🖥️ Not sharing';
                
                updateStatus(mediaStatus, `Mic: ${micStatus} | Camera: ${cameraStatus} | Screen: ${screenStatus}`, 'info');
                
                // Update button texts
                toggleMicBtn.textContent = meeting.localMicOn ? 'Mute Mic' : 'Unmute Mic';
                toggleCameraBtn.textContent = meeting.localWebcamOn ? 'Disable Camera' : 'Enable Camera';
                toggleScreenBtn.textContent = meeting.localScreenShareOn ? 'Stop Sharing' : 'Share Screen';
            }
        }
        
        function updateParticipantsList() {
            const count = participants.size + (meeting ? 1 : 0); // +1 for local participant
            participantsList.innerHTML = `<strong>Participants (${count}):</strong><br>`;
            
            if (meeting) {
                participantsList.innerHTML += '• You (Local)<br>';
            }
            
            participants.forEach((participant) => {
                participantsList.innerHTML += `• ${participant.displayName}<br>`;
            });
        }
        
        function setupParticipantVideo(participant) {
            const videoElement = document.createElement('div');
            videoElement.className = 'video-item';
            videoElement.id = `participant-${participant.id}`;
            
            videoElement.innerHTML = `
                <video id="video-${participant.id}" autoplay muted></video>
                <div class="participant-info">
                    <div>${participant.displayName}</div>
                </div>
            `;
            
            videoContainer.appendChild(videoElement);
            
            // Set up video stream
            participant.on('stream-enabled', (stream) => {
                if (stream.kind === 'video') {
                    const videoEl = document.getElementById(`video-${participant.id}`);
                    if (videoEl) {
                        const mediaStream = new MediaStream();
                        mediaStream.addTrack(stream.track);
                        videoEl.srcObject = mediaStream;
                    }
                }
            });
        }
        
        function removeParticipantVideo(participantId) {
            const videoElement = document.getElementById(`participant-${participantId}`);
            if (videoElement) {
                videoElement.remove();
            }
        }
        
        // Event listeners
        createMeetingBtn.addEventListener('click', createMeeting);
        joinMeetingBtn.addEventListener('click', () => joinMeeting());
        leaveMeetingBtn.addEventListener('click', leaveMeeting);
        toggleMicBtn.addEventListener('click', toggleMicrophone);
        toggleCameraBtn.addEventListener('click', toggleCamera);
        toggleScreenBtn.addEventListener('click', toggleScreenShare);
        
        // Initialize when page loads
        window.addEventListener('load', () => {
            log('🌟 VideoSDK Integration Test Started');
            
            // Check if VideoSDK library loaded
            setTimeout(() => {
                if (typeof VideoSDK !== 'undefined') {
                    updateStatus(libraryStatus, '✅ VideoSDK library loaded successfully', 'success');
                    initializeVideoSDK();
                } else {
                    updateStatus(libraryStatus, '❌ VideoSDK library failed to load', 'error');
                    log('❌ VideoSDK library not available');
                }
            }, 1000);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Section JavaScript Fixes Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #2f3136; 
            color: white; 
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: #36393f;
            padding: 20px;
            border-radius: 8px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #40444b;
            border-radius: 5px;
        }
        .success { color: #43b581; }
        .error { color: #f04747; }
        .warning { color: #faa61a; }
        button {
            background: #5865f2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #4752c4; }
        #test-output {
            background: #2f3136;
            border: 1px solid #40444b;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Voice Section JavaScript Fixes Test</h1>
        
        <div class="test-section">
            <h3>üß™ Module System Compatibility Test</h3>
            <p>Testing the enhanced module system polyfills for VideoSDK compatibility.</p>
            <button onclick="testModuleSystem()">Test Module System</button>
        </div>
        
        <div class="test-section">
            <h3>üì¶ VideoSDK Loading Simulation</h3>
            <p>Simulating VideoSDK loading with module conflicts.</p>
            <button onclick="testVideoSDKLoading()">Simulate VideoSDK Load</button>
        </div>
        
        <div class="test-section">
            <h3>‚öôÔ∏è Configuration Validation Test</h3>
            <p>Testing the meeting configuration validation.</p>
            <button onclick="testConfigValidation()">Test Configuration</button>
        </div>
        
        <div class="test-section">
            <h3>üéØ Meeting Initialization Test</h3>
            <p>Testing meeting configuration object structure.</p>
            <button onclick="testMeetingInit()">Test Meeting Init</button>
        </div>
        
        <div id="test-output"></div>
    </div>

    <!-- Enhanced module system compatibility - must be loaded first -->
    <script>
    (function() {
        'use strict';
        
        // Comprehensive module system polyfill for VideoSDK compatibility
        console.log('üîß Setting up enhanced module system compatibility...');
        
        // First, create a safe environment that prevents all module-related errors
        const originalError = console.error;
        const moduleErrors = [];
        
        // Override console.error to catch and suppress module errors early
        console.error = function(...args) {
            const message = args[0];
            if (typeof message === 'string' && 
                (message.includes('exports is not defined') || 
                 message.includes('module is not defined') ||
                 message.includes('require is not defined') ||
                 message.includes('global is not defined'))) {
                moduleErrors.push(message);
                console.log('üõ°Ô∏è Suppressed module error:', message);
                return;
            }
            originalError.apply(console, args);
        };
        
        // CommonJS compatibility with enhanced features
        if (typeof window.exports === 'undefined') {
            window.exports = {};
            console.log('‚úì window.exports polyfill added');
        }
        
        if (typeof window.module === 'undefined') {
            window.module = { 
                exports: window.exports,
                id: 'browser',
                filename: window.location.href,
                loaded: false,
                children: [],
                paths: []
            };
            console.log('‚úì window.module polyfill added');
        }
        
        if (typeof window.global === 'undefined') {
            window.global = window;
            console.log('‚úì window.global polyfill added');
        }
        
        // Enhanced process object for Node.js compatibility
        if (typeof window.process === 'undefined') {
            window.process = {
                env: {},
                nextTick: function(callback) { setTimeout(callback, 0); },
                browser: true,
                version: 'v16.0.0',
                versions: { node: '16.0.0' }
            };
            console.log('‚úì window.process polyfill added');
        }
        
        // Buffer polyfill for VideoSDK
        if (typeof window.Buffer === 'undefined') {
            window.Buffer = {
                isBuffer: function() { return false; },
                from: function(data) { return new Uint8Array(data); }
            };
            console.log('‚úì window.Buffer polyfill added');
        }
        
        // Enhanced CommonJS require polyfill with better module resolution
        if (typeof window.require === 'undefined') {
            window.require = function(module) {
                console.warn('CommonJS require() called for:', module);
                
                // Enhanced module resolution for known patterns
                switch (module) {
                    case 'events':
                        return { 
                            EventEmitter: class EventEmitter {
                                constructor() { this.events = {}; }
                                on(event, listener) { this.events[event] = this.events[event] || []; this.events[event].push(listener); }
                                emit(event, ...args) { (this.events[event] || []).forEach(fn => fn(...args)); }
                            }
                        };
                    case 'util':
                        return { 
                            inherits: function(constructor, superConstructor) {
                                constructor.prototype = Object.create(superConstructor.prototype);
                                constructor.prototype.constructor = constructor;
                            }
                        };
                    case 'stream':
                        return { Readable: class {}, Writable: class {}, Transform: class {} };
                    case 'crypto':
                        return { 
                            createHash: function() { return { update: function() { return this; }, digest: function() { return 'mock-hash'; } }; }
                        };
                    case 'path':
                        return { 
                            join: function(...args) { return args.join('/'); },
                            resolve: function(...args) { return args.join('/'); }
                        };
                    case 'fs':
                        return { 
                            readFileSync: function() { throw new Error('fs not available in browser'); },
                            writeFileSync: function() { throw new Error('fs not available in browser'); }
                        };
                    default:
                        return window.exports || {};
                }
            };
            console.log('‚úì Enhanced CommonJS require polyfill added');
        }
        
        // Ultra-comprehensive error handling
        const originalErrorHandler = window.onerror;
        window.onerror = function(message, source, lineno, colno, error) {
            if (message && typeof message === 'string') {
                if (message.includes('exports is not defined') || 
                    message.includes('module is not defined') ||
                    message.includes('require is not defined') ||
                    message.includes('global is not defined') ||
                    message.includes('process is not defined') ||
                    message.includes('Buffer is not defined')) {
                    console.log('üõ†Ô∏è Module system error caught and suppressed:', message);
                    return true; // Prevent default error handling
                }
            }
            
            if (originalErrorHandler) {
                return originalErrorHandler.apply(this, arguments);
            }
            return false;
        };
        
        // Enhanced unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message) {
                const message = event.reason.message;
                if (message.includes('exports is not defined') ||
                    message.includes('module is not defined') ||
                    message.includes('require is not defined') ||
                    message.includes('global is not defined') ||
                    message.includes('process is not defined') ||
                    message.includes('Buffer is not defined')) {
                    console.log('üõ†Ô∏è Module system promise rejection suppressed:', message);
                    event.preventDefault();
                    return;
                }
            }
        });
        
        // Restore original console.error after setup
        setTimeout(() => {
            console.error = originalError;
            if (moduleErrors.length > 0) {
                console.log('üõ°Ô∏è Suppressed', moduleErrors.length, 'module system errors during setup');
            }
        }, 100);
        
        console.log('‚úÖ Enhanced module system compatibility setup complete');
    })();
    </script>

    <script>
    // Test configuration
    const testConfig = {
        apiKey: 'test-api-key-12345678',
        token: 'test-token-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9',
        isProduction: false
    };
    
    const testMeetingId = 'test-meeting-123';
    const testUserName = 'Test User';
    
    function log(message, type = 'info') {
        const output = document.getElementById('test-output');
        const timestamp = new Date().toLocaleTimeString();
        const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : '';
        output.innerHTML += `[${timestamp}] <span class="${className}">${message}</span>\n`;
        output.scrollTop = output.scrollHeight;
        console.log(message);
    }
    
    function testModuleSystem() {
        log('üß™ Testing Module System Compatibility...', 'info');
        
        try {
            // Test basic module objects
            log('Testing exports object: ' + (typeof exports !== 'undefined' ? '‚úÖ PASS' : '‚ùå FAIL'), 
                typeof exports !== 'undefined' ? 'success' : 'error');
            
            log('Testing module object: ' + (typeof module !== 'undefined' ? '‚úÖ PASS' : '‚ùå FAIL'), 
                typeof module !== 'undefined' ? 'success' : 'error');
                
            log('Testing global object: ' + (typeof global !== 'undefined' ? '‚úÖ PASS' : '‚ùå FAIL'), 
                typeof global !== 'undefined' ? 'success' : 'error');
                
            log('Testing process object: ' + (typeof process !== 'undefined' ? '‚úÖ PASS' : '‚ùå FAIL'), 
                typeof process !== 'undefined' ? 'success' : 'error');
                
            log('Testing Buffer object: ' + (typeof Buffer !== 'undefined' ? '‚úÖ PASS' : '‚ùå FAIL'), 
                typeof Buffer !== 'undefined' ? 'success' : 'error');
                
            log('Testing require function: ' + (typeof require !== 'undefined' ? '‚úÖ PASS' : '‚ùå FAIL'), 
                typeof require !== 'undefined' ? 'success' : 'error');
            
            // Test require functionality
            const events = require('events');
            const EventEmitter = events.EventEmitter;
            const emitter = new EventEmitter();
            emitter.on('test', () => log('Event emitter test: ‚úÖ PASS', 'success'));
            emitter.emit('test');
            
            log('Module system compatibility test completed successfully!', 'success');
            
        } catch (error) {
            log('Module system test failed: ' + error.message, 'error');
        }
    }
    
    function testVideoSDKLoading() {
        log('üì¶ Simulating VideoSDK Loading...', 'info');
        
        try {
            // Simulate common VideoSDK module conflicts
            eval('var exports = {}; var module = { exports: exports };');
            log('Eval with exports/module: ‚úÖ PASS', 'success');
            
            // Test module assignment patterns
            if (typeof exports !== 'undefined') {
                exports.VideoSDKMeeting = function() {
                    log('Mock VideoSDKMeeting constructor called', 'info');
                };
                log('VideoSDK exports assignment: ‚úÖ PASS', 'success');
            }
            
            // Simulate error conditions that might occur
            try {
                eval('undefined_variable.someProperty = "test";');
            } catch (e) {
                log('Undefined variable error handled: ‚úÖ PASS', 'success');
            }
            
            log('VideoSDK loading simulation completed!', 'success');
            
        } catch (error) {
            log('VideoSDK loading simulation failed: ' + error.message, 'error');
        }
    }
    
    function testConfigValidation() {
        log('‚öôÔ∏è Testing Configuration Validation...', 'info');
        
        try {
            // Test validation function
            function validateConfig(config) {
                const hasApiKey = config.apiKey && typeof config.apiKey === 'string' && config.apiKey.trim().length > 0;
                const hasToken = config.token && typeof config.token === 'string' && config.token.trim().length > 0;
                
                return {
                    hasApiKey: hasApiKey,
                    hasToken: hasToken,
                    isValid: hasApiKey && hasToken
                };
            }
            
            const validation = validateConfig(testConfig);
            log('API Key validation: ' + (validation.hasApiKey ? '‚úÖ PASS' : '‚ùå FAIL'), 
                validation.hasApiKey ? 'success' : 'error');
            log('Token validation: ' + (validation.hasToken ? '‚úÖ PASS' : '‚ùå FAIL'), 
                validation.hasToken ? 'success' : 'error');
            log('Overall validation: ' + (validation.isValid ? '‚úÖ PASS' : '‚ùå FAIL'), 
                validation.isValid ? 'success' : 'error');
                
            // Test with invalid config
            const invalidConfig = { apiKey: '', token: null };
            const invalidValidation = validateConfig(invalidConfig);
            log('Invalid config rejection: ' + (!invalidValidation.isValid ? '‚úÖ PASS' : '‚ùå FAIL'), 
                !invalidValidation.isValid ? 'success' : 'error');
            
            log('Configuration validation test completed!', 'success');
            
        } catch (error) {
            log('Configuration validation test failed: ' + error.message, 'error');
        }
    }
    
    function testMeetingInit() {
        log('üéØ Testing Meeting Initialization...', 'info');
        
        try {
            // Test meeting configuration object structure
            const meetingConfig = {
                containerId: 'video-grid',
                meetingId: 'misvord-voice-' + testMeetingId.replace(/[^a-zA-Z0-9]/g, "-"),
                name: testUserName.trim(),
                micEnabled: true,
                webcamEnabled: false,
                participantId: "user-" + Math.floor(Math.random() * 10000),
                joinScreen: { visible: false },
                
                // Event handlers
                joined: function() {
                    log('Mock joined event handler called', 'info');
                },
                
                participantJoined: function(participant) {
                    log('Mock participantJoined event handler called', 'info');
                },
                
                participantLeft: function(participant) {
                    log('Mock participantLeft event handler called', 'info');
                },
                
                error: function(error) {
                    log('Mock error event handler called', 'warning');
                }
            };
            
            // Add credentials
            meetingConfig.apiKey = testConfig.apiKey.trim();
            meetingConfig.token = testConfig.token.trim();
            
            log('Meeting config structure: ‚úÖ PASS', 'success');
            log('Required fields present: ' + 
                (meetingConfig.apiKey && meetingConfig.token && meetingConfig.meetingId && 
                 meetingConfig.name ? '‚úÖ PASS' : '‚ùå FAIL'), 
                meetingConfig.apiKey && meetingConfig.token && meetingConfig.meetingId && 
                meetingConfig.name ? 'success' : 'error');
            
            log('Event handlers defined: ' + 
                (typeof meetingConfig.joined === 'function' && 
                 typeof meetingConfig.participantJoined === 'function' ? '‚úÖ PASS' : '‚ùå FAIL'),
                typeof meetingConfig.joined === 'function' && 
                typeof meetingConfig.participantJoined === 'function' ? 'success' : 'error');
            
            // Test event handler execution
            meetingConfig.joined();
            meetingConfig.participantJoined({ id: 'test', displayName: 'Test' });
            
            log('Meeting initialization test completed!', 'success');
            
        } catch (error) {
            log('Meeting initialization test failed: ' + error.message, 'error');
        }
    }
    
    // Run initial tests
    document.addEventListener('DOMContentLoaded', function() {
        log('üöÄ Voice Section JavaScript Fixes Test Started', 'info');
        log('All polyfills and enhancements are loaded and ready for testing.', 'success');
    });
    </script>
</body>
</html>

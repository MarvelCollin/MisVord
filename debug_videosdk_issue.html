<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoSDK Configuration Debug</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #2f3136; 
            color: white; 
        }
        .debug-container {
            max-width: 1000px;
            margin: 0 auto;
            background: #36393f;
            padding: 20px;
            border-radius: 8px;
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            background: #40444b;
            border-radius: 5px;
        }
        .success { color: #43b581; }
        .error { color: #f04747; }
        .warning { color: #faa61a; }
        pre {
            background: #2f3136;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #5865f2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #4752c4; }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>üîç VideoSDK Configuration Debug</h1>
        <p>This page helps debug VideoSDK configuration issues by testing the actual configuration structure.</p>
        
        <div class="debug-section">
            <h3>üìä Current Configuration</h3>
            <div id="config-output">Loading configuration...</div>
        </div>
        
        <div class="debug-section">
            <h3>üß™ Test VideoSDK Initialization</h3>
            <p>Test if VideoSDK can be initialized with the current configuration.</p>
            <button onclick="testVideoSDKInit()">Test VideoSDK Init</button>
            <button onclick="loadVideoSDKScript()">Load VideoSDK Script</button>
            <div id="test-output"></div>
        </div>
        
        <div class="debug-section">
            <h3>üìã Meeting Configuration Preview</h3>
            <p>Preview how the meeting configuration object would be structured.</p>
            <button onclick="previewMeetingConfig()">Preview Config</button>
            <div id="meeting-preview"></div>
        </div>
    </div>

    <!-- Module system compatibility -->
    <script>
    // Enhanced module system polyfills
    (function() {
        'use strict';
        
        if (typeof window.exports === 'undefined') {
            window.exports = {};
        }
        
        if (typeof window.module === 'undefined') {
            window.module = { 
                exports: window.exports,
                id: 'browser',
                filename: window.location.href,
                loaded: false,
                children: [],
                paths: []
            };
        }
        
        if (typeof window.global === 'undefined') {
            window.global = window;
        }
        
        if (typeof window.process === 'undefined') {
            window.process = {
                env: {},
                nextTick: function(callback) { setTimeout(callback, 0); },
                browser: true,
                version: 'v16.0.0',
                versions: { node: '16.0.0' }
            };
        }
        
        if (typeof window.Buffer === 'undefined') {
            window.Buffer = {
                isBuffer: function() { return false; },
                from: function(data) { return new Uint8Array(data); }
            };
        }
        
        if (typeof window.require === 'undefined') {
            window.require = function(module) {
                console.warn('CommonJS require() called for:', module);
                switch (module) {
                    case 'events':
                        return { 
                            EventEmitter: class EventEmitter {
                                constructor() { this.events = {}; }
                                on(event, listener) { this.events[event] = this.events[event] || []; this.events[event].push(listener); }
                                emit(event, ...args) { (this.events[event] || []).forEach(fn => fn(...args)); }
                            }
                        };
                    default:
                        return window.exports || {};
                }
            };
        }
        
        console.log('‚úÖ Module system compatibility setup complete');
    })();
    </script>

    <script>
    // Test configuration - you can modify these values to test different scenarios
    const testConfig = {
        apiKey: 'test-api-key-1234567890abcdef',
        token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhcGlfa2V5IjoidGVzdCIsInBlcm1pc3Npb25zIjpbImFsbG93X2pvaW4iXSwiaWF0IjoxNjAwMDAwMDAwLCJleHAiOjE2MDAwMDAwMDB9.test-signature',
        isProduction: false
    };
    
    const testMeetingId = 'test-meeting-debug-123';
    const testUserName = 'Debug User';
    
    function log(message, type = 'info') {
        console.log(message);
        const output = document.getElementById('test-output');
        if (output) {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : '';
            output.innerHTML += `[${timestamp}] <span class="${className}">${message}</span><br>`;
        }
    }
    
    function displayConfig() {
        const output = document.getElementById('config-output');
        const configHTML = `
            <h4>Configuration Analysis:</h4>
            <pre>${JSON.stringify(testConfig, null, 2)}</pre>
            
            <h4>Validation Results:</h4>
            <ul>
                <li class="${testConfig.apiKey ? 'success' : 'error'}">
                    API Key: ${testConfig.apiKey ? '‚úÖ Present (' + testConfig.apiKey.substring(0, 8) + '...)' : '‚ùå Missing'}
                </li>
                <li class="${testConfig.token ? 'success' : 'error'}">
                    Token: ${testConfig.token ? '‚úÖ Present (' + testConfig.token.substring(0, 20) + '...)' : '‚ùå Missing'}
                </li>
                <li class="${testConfig.apiKey && testConfig.token ? 'success' : 'error'}">
                    Overall: ${testConfig.apiKey && testConfig.token ? '‚úÖ Valid Configuration' : '‚ùå Invalid Configuration'}
                </li>
            </ul>
            
            <h4>Expected VideoSDK Meeting Config Structure:</h4>
            <pre>const meetingConfig = {
    containerId: 'video-grid',
    meetingId: 'misvord-voice-test-meeting-debug-123',
    name: 'Debug User',
    micEnabled: true,
    webcamEnabled: false,
    participantId: 'user-1234',
    joinScreen: { visible: false },
    
    // Event handlers
    joined: function() { ... },
    participantJoined: function(participant) { ... },
    participantLeft: function(participant) { ... },
    error: function(error) { ... },
    
    // Credentials (added after object creation)
    apiKey: '${testConfig.apiKey}',
    token: '${testConfig.token}'
};</pre>
        `;
        output.innerHTML = configHTML;
    }
    
    function previewMeetingConfig() {
        const output = document.getElementById('meeting-preview');
        
        try {
            // Create the exact meeting configuration structure
            const validMeetingId = "misvord-voice-" + testMeetingId.replace(/[^a-zA-Z0-9]/g, "-");
            
            const meetingConfig = {
                containerId: 'video-grid',
                meetingId: validMeetingId,
                name: testUserName.trim(),
                micEnabled: true,
                webcamEnabled: false,
                participantId: "user-" + Math.floor(Math.random() * 10000),
                joinScreen: { visible: false },
                
                // Event handlers
                joined: function() {
                    console.log('‚úÖ Successfully joined meeting');
                },
                
                participantJoined: function(participant) {
                    console.log('üë§ Participant joined:', participant.displayName || participant.id);
                },
                
                participantLeft: function(participant) {
                    console.log('üë§ Participant left:', participant.displayName || participant.id);
                },
                
                error: function(error) {
                    console.error('üí• Meeting error:', error);
                }
            };
            
            // Add credentials
            meetingConfig.apiKey = testConfig.apiKey.trim();
            meetingConfig.token = testConfig.token.trim();
            
            // Create a preview object for display (without functions)
            const previewConfig = {
                containerId: meetingConfig.containerId,
                meetingId: meetingConfig.meetingId,
                name: meetingConfig.name,
                micEnabled: meetingConfig.micEnabled,
                webcamEnabled: meetingConfig.webcamEnabled,
                participantId: meetingConfig.participantId,
                joinScreen: meetingConfig.joinScreen,
                apiKey: meetingConfig.apiKey,
                token: meetingConfig.token,
                eventHandlers: {
                    joined: 'function() { ... }',
                    participantJoined: 'function(participant) { ... }',
                    participantLeft: 'function(participant) { ... }',
                    error: 'function(error) { ... }'
                }
            };
            
            output.innerHTML = `
                <h4>‚úÖ Meeting Configuration Preview:</h4>
                <pre>${JSON.stringify(previewConfig, null, 2)}</pre>
                
                <h4>Validation:</h4>
                <ul>
                    <li class="success">‚úÖ Object structure is correct</li>
                    <li class="success">‚úÖ Event handlers are included in the object</li>
                    <li class="success">‚úÖ Credentials are properly assigned</li>
                    <li class="success">‚úÖ All required fields are present</li>
                </ul>
            `;
            
        } catch (error) {
            output.innerHTML = `<div class="error">‚ùå Error creating meeting config: ${error.message}</div>`;
        }
    }
    
    function loadVideoSDKScript() {
        log('üì¶ Loading VideoSDK script...', 'info');
        
        if (typeof VideoSDKMeeting !== 'undefined') {
            log('‚úÖ VideoSDK already loaded', 'success');
            return;
        }
        
        // Enhanced error suppression
        const originalError = console.error;
        const suppressedErrors = [];
        
        console.error = function(...args) {
            const message = args[0];
            if (typeof message === 'string' && 
                (message.includes('exports is not defined') || 
                 message.includes('module is not defined') ||
                 message.includes('require is not defined'))) {
                suppressedErrors.push(message);
                return;
            }
            originalError.apply(console, args);
        };
        
        const script = document.createElement('script');
        script.src = 'https://sdk.videosdk.live/rtc-js-prebuilt/0.3.31/rtc-js-prebuilt.js';
        script.async = true;
        
        script.onerror = function(event) {
            console.error = originalError;
            log('‚ùå Failed to load VideoSDK script: ' + event, 'error');
        };
        
        script.onload = function() {
            setTimeout(() => {
                console.error = originalError;
                if (suppressedErrors.length > 0) {
                    log('üõ°Ô∏è Suppressed ' + suppressedErrors.length + ' module errors', 'warning');
                }
            }, 1000);
            
            setTimeout(() => {
                if (typeof VideoSDKMeeting !== 'undefined') {
                    log('‚úÖ VideoSDK loaded successfully', 'success');
                } else {
                    // Try alternative namespaces
                    if (window.VideoSDK && window.VideoSDK.VideoSDKMeeting) {
                        window.VideoSDKMeeting = window.VideoSDK.VideoSDKMeeting;
                        log('‚úÖ VideoSDK found via VideoSDK namespace', 'success');
                    } else if (window.rtcJsPrebuilt && window.rtcJsPrebuilt.VideoSDKMeeting) {
                        window.VideoSDKMeeting = window.rtcJsPrebuilt.VideoSDKMeeting;
                        log('‚úÖ VideoSDK found via rtcJsPrebuilt namespace', 'success');
                    } else {
                        log('‚ùå VideoSDKMeeting class not found in any namespace', 'error');
                        log('Available objects: ' + Object.keys(window).filter(key => key.toLowerCase().includes('video')).join(', '), 'info');
                    }
                }
            }, 1500);
        };
        
        document.head.appendChild(script);
    }
    
    function testVideoSDKInit() {
        log('üß™ Testing VideoSDK initialization...', 'info');
        
        if (typeof VideoSDKMeeting === 'undefined') {
            log('‚ùå VideoSDKMeeting class not available. Load script first.', 'error');
            return;
        }
        
        try {
            // Create the exact meeting configuration
            const validMeetingId = "misvord-voice-" + testMeetingId.replace(/[^a-zA-Z0-9]/g, "-");
            
            const meetingConfig = {
                containerId: 'video-grid',
                meetingId: validMeetingId,
                name: testUserName.trim(),
                micEnabled: true,
                webcamEnabled: false,
                participantId: "user-" + Math.floor(Math.random() * 10000),
                joinScreen: { visible: false },
                
                // Event handlers
                joined: function() {
                    log('‚úÖ Mock meeting joined successfully!', 'success');
                },
                
                participantJoined: function(participant) {
                    log('üë§ Mock participant joined: ' + (participant.displayName || participant.id), 'info');
                },
                
                participantLeft: function(participant) {
                    log('üë§ Mock participant left: ' + (participant.displayName || participant.id), 'info');
                },
                
                error: function(error) {
                    log('üí• Mock meeting error: ' + error.message, 'error');
                }
            };
            
            // Add credentials
            meetingConfig.apiKey = testConfig.apiKey.trim();
            meetingConfig.token = testConfig.token.trim();
            
            log('Creating VideoSDK meeting with config...', 'info');
            log('API Key: ' + (meetingConfig.apiKey ? 'SET' : 'MISSING'), meetingConfig.apiKey ? 'success' : 'error');
            log('Token: ' + (meetingConfig.token ? 'SET' : 'MISSING'), meetingConfig.token ? 'success' : 'error');
            
            const meeting = new VideoSDKMeeting(meetingConfig);
            
            log('‚úÖ VideoSDK meeting created successfully!', 'success');
            
            if (typeof meeting.init === 'function') {
                log('Calling meeting.init()...', 'info');
                meeting.init();
                log('‚úÖ Meeting initialization completed!', 'success');
            } else {
                log('‚ùå Meeting object does not have init() method', 'error');
            }
            
        } catch (error) {
            log('‚ùå VideoSDK initialization failed: ' + error.message, 'error');
            
            // Analyze the error
            if (error.message.includes('token') && error.message.includes('apiKey')) {
                log('üîç This is the credential error we are trying to fix!', 'warning');
                log('Error suggests VideoSDK did not receive proper credentials', 'warning');
            }
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        displayConfig();
        log('üöÄ VideoSDK Debug Page Loaded', 'info');
        log('Click "Load VideoSDK Script" then "Test VideoSDK Init" to reproduce the error', 'info');
    });
    </script>
</body>
</html>
